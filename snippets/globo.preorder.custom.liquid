<script>
/**
 * Globo Pre-order Custom Configuration
 * Fixed for consistent preorder button display
 * Uses Promise-based waiting and proper event handling
 */
(function() {
    'use strict';

    // Global state
    window.GloboPreorderCustomState = {
        initialized: false,
        globoReady: false,
        productData: null,
        retryCount: 0,
        maxRetries: 50,
        observers: []
    };

    // Wait for an element or condition with timeout
    function waitForCondition(condition, timeout = 30000) {
        return new Promise((resolve, reject) => {
            const startTime = Date.now();

            function check() {
                if (condition()) {
                    resolve(true);
                    return;
                }

                if (Date.now() - startTime > timeout) {
                    reject(new Error('Timeout waiting for condition'));
                    return;
                }

                requestAnimationFrame(check);
            }

            check();
        });
    }

    // Load product data from available JSON scripts
    function loadProductData() {
        if (window.GloboPreorderCustomState.productData) {
            return window.GloboPreorderCustomState.productData;
        }

        const scripts = document.querySelectorAll('script[data-product-json], script[data-globo-preorder-product]');
        for (let script of scripts) {
            try {
                const data = JSON.parse(script.textContent);
                if (data && data.id) {
                    window.GloboPreorderCustomState.productData = data;
                    window.GloboPreorderParams = window.GloboPreorderParams || {};
                    window.GloboPreorderParams.product = data;
                    window.GloboPreorderParams.page = 'product';
                    console.log('[Globo] Product loaded:', data.id);
                    return data;
                }
            } catch (e) {}
        }
        return null;
    }

    // Initialize selectors once
    function initSelectors() {
        window.GloboPreorderParams = window.GloboPreorderParams || {};
        window.GloboPreorderParams.selectors = window.GloboPreorderParams.selectors || {};
        window.GloboPreorderParams.page = 'product';

        window.GloboPreorderParams.selectors.productPositionBis = '.gPositionBis, .modern-globo-preorder-container, .globo-preorder-bis-hook';
        window.GloboPreorderParams.selectors.productForm = "form.product-form, form[data-product-form], .modern-product-form__form, .singleProductPreOrderForm, product-form form";

        const addToCartSelectors = ['[data-action="add-to-cart"]', '.product-form__add-button', '.modern-add-to-cart', '[name="add"]'];
        if (!Array.isArray(window.GloboPreorderParams.selectors.productAddToCartBtn)) {
            window.GloboPreorderParams.selectors.productAddToCartBtn = [];
        }
        addToCartSelectors.forEach(s => {
            if (!window.GloboPreorderParams.selectors.productAddToCartBtn.includes(s)) {
                window.GloboPreorderParams.selectors.productAddToCartBtn.push(s);
            }
        });

        window.GloboPreorderParams.selectors.productPaymentContainer = ".product-form__payment-container, .modern-atc-wrapper";
        window.GloboPreorderParams.selectors.productQuantitySelector = ".quantity-selector__value, .modern-quantity-input, input[name='quantity']";

        console.log('[Globo] Selectors initialized');
    }

    // Main refresh function - tries all possible methods
    function refreshPreorder(source = 'unknown') {
        if (!window.Globo || !window.Globo.Preorder) {
            console.log('[Globo] Not ready, skipping refresh from:', source);
            return;
        }

        console.log('[Globo] Refreshing from:', source);

        // Load fresh product data
        loadProductData();

        // Try all available methods
        const methods = Object.keys(window.Globo.Preorder).filter(k => typeof window.Globo.Preorder[k] === 'function');
        console.log('[Globo] Available methods:', methods);

        // Priority order of methods to try
        const priorityMethods = ['initPreorder', 'render', 'renderProductForm', 'renderProductByForm', 'init', 'load'];

        for (let method of priorityMethods) {
            if (methods.includes(method)) {
                try {
                    console.log('[Globo] Calling:', method);

                    if (method === 'renderProductForm' && window.GloboPreorderParams?.product) {
                        window.Globo.Preorder[method](window.GloboPreorderParams.product);
                    } else if (method === 'renderProductByForm') {
                        const form = document.querySelector('.singleProductPreOrderForm, .modern-product-form__form');
                        if (form) window.Globo.Preorder[method](form);
                    } else {
                        window.Globo.Preorder[method]();
                    }
                } catch (e) {
                    console.warn('[Globo] Method', method, 'error:', e.message);
                }
            }
        }

        // Trigger custom event
        document.dispatchEvent(new CustomEvent('globo.preorder.variant.changed', {
            detail: { product: window.GloboPreorderParams?.product }
        }));

        // Log state
        const gPos = document.querySelector('.gPositionBis');
        console.log('[Globo] State:', {
            gPositionBis: !!gPos,
            hasContent: gPos ? gPos.innerHTML.length > 0 : false,
            content: gPos ? gPos.innerHTML.substring(0, 50) : 'N/A'
        });
    }

    // Set up variant change listeners
    function setupVariantListeners() {
        // Use event delegation with capture phase
        document.addEventListener('change', function(e) {
            const target = e.target;
            if (target.matches('input[type="radio"], input[name^="option"], select[name="id"]') ||
                target.closest('.modern-variant-swatch') ||
                target.closest('variant-picker')) {
                console.log('[Globo] Variant changed');
                refreshPreorder('variant-change');
            }
        }, true);

        document.addEventListener('click', function(e) {
            const target = e.target;
            if (target.matches('.modern-variant-swatch, .modern-variant-swatch *') ||
                target.closest('.modern-variant-swatch')) {
                console.log('[Globo] Variant clicked');
                setTimeout(() => refreshPreorder('variant-click'), 100);
            }
        }, true);
    }

    // Set up mutation observer for DOM changes
    function setupMutationObserver() {
        const observer = new MutationObserver((mutations) => {
            for (let mutation of mutations) {
                if (mutation.type === 'childList') {
                    for (let node of mutation.addedNodes) {
                        if (node.nodeType === 1 && (
                            node.classList?.contains('gPositionBis') ||
                            node.classList?.contains('modern-variant-swatch') ||
                            node.querySelector?.('.gPositionBis') ||
                            node.querySelector?.('.modern-variant-swatch')
                        )) {
                            refreshPreorder('dom-mutation');
                            break;
                        }
                    }
                }
            }
        });

        // Start observing when form exists
        const startObserving = () => {
            const form = document.querySelector('.modern-product-form__form, .singleProductPreOrderForm');
            if (form) {
                observer.observe(form, { childList: true, subtree: true });
                console.log('[Globo] MutationObserver attached');
            } else {
                setTimeout(startObserving, 500);
            }
        };
        startObserving();
    }

    // Main initialization
    async function init() {
        console.log('[Globo] Starting initialization...');

        // Initialize selectors immediately
        initSelectors();
        loadProductData();
        setupVariantListeners();
        setupMutationObserver();

        // Wait for Globo to be ready
        try {
            await waitForCondition(() => window.Globo && window.Globo.Preorder, 15000);
            console.log('[Globo] Globo.Preorder is ready!');

            window.GloboPreorderCustomState.globoReady = true;

            // Initial refresh
            refreshPreorder('initial');

            // Set up periodic checks (debounced)
            let lastCheck = 0;
            setInterval(() => {
                const now = Date.now();
                if (now - lastCheck > 3000) {
                    lastCheck = now;
                    const gPos = document.querySelector('.gPositionBis');
                    if (gPos && gPos.innerHTML.length === 0) {
                        console.log('[Globo] Periodic: gPositionBis empty, refreshing');
                        refreshPreorder('periodic');
                    }
                }
            }, 5000);

        } catch (e) {
            console.error('[Globo] Failed to initialize:', e.message);
        }
    }

    // Start initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Also try on window load
    window.addEventListener('load', () => {
        setTimeout(() => refreshPreorder('window-load'), 500);
        setTimeout(() => refreshPreorder('window-load-delayed'), 1500);
    });

    // Export helper
    window.GloboPreorderCustom = {
        refresh: refreshPreorder,
        init: init
    };

    console.log('[Globo] Custom script loaded');
})();
</script>

<style>
/* ========================================
   Globo Pre-order Custom Styles
   For Modern Product Page Integration
   ======================================== */

/* Main Container */
.gPositionBis,
.modern-globo-preorder-container,
.globo-preorder-bis-hook {
    width: 100% !important;
    max-width: 100% !important;
    margin: 12px 0 0 0 !important;
    padding: 0 !important;
    display: block !important;
    box-sizing: border-box !important;
    clear: both !important;
    float: none !important;
    position: relative !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Ensure visibility when content exists */
.gPositionBis:not(:empty),
.modern-globo-preorder-container:not(:empty),
.globo-preorder-bis-hook:not(:empty) {
    display: block !important;
}

/* Force all children to be block and visible */
.gPositionBis > *,
.modern-globo-preorder-container > *,
.globo-preorder-bis-hook > * {
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    margin: 0 !important;
    padding: 0 !important;
    float: none !important;
}

/* Pre-order Button */
.gPreorderBtn,
.modern-product-form .gPreorderBtn,
.product-form .gPreorderBtn,
form.product-form button.gPreorderBtn {
    background: #D32F2F !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 0 24px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    width: 100% !important;
    max-width: 100% !important;
    min-height: 52px !important;
    display: block !important;
    line-height: 52px !important;
    text-align: center !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 4px 12px rgb(211 47 47 / 0.3) !important;
    float: none !important;
    margin: 8px 0 0 0 !important;
}

.gPreorderBtn:hover:not(:disabled) {
    background: #B71C1C !important;
    transform: translateY(-1px) !important;
}

/* Back in Stock Button */
.gBackInStockBtn,
#Globo-Back-In-Stock .gBackInStockBtn {
    animation: gpo-glowing 1500ms infinite !important;
    display: block !important;
    text-align: center !important;
    background: #40C4FF !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 0 24px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    width: 100% !important;
    max-width: 100% !important;
    min-height: 52px !important;
    line-height: 52px !important;
    box-shadow: 0 4px 12px rgb(64 196 255 / 0.3) !important;
    float: none !important;
    margin: 8px 0 0 0 !important;
}

@keyframes gpo-glowing {
    0% { background-color: #40C4FF; box-shadow: 0 0 5px #40C4FF; }
    50% { background-color: #0288D1; box-shadow: 0 0 15px #0288D1; }
    100% { background-color: #40C4FF; box-shadow: 0 0 5px #40C4FF; }
}

/* Form elements */
#Globo-Back-In-Stock,
.globo-preorder-app,
.gpo-form-wrapper,
.gPreorderWrapper {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    display: block !important;
}

#Globo-Back-In-Stock input[type="email"],
#Globo-Back-In-Stock input[type="text"],
.gPositionBis input {
    width: 100% !important;
    padding: 14px 16px !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 10px !important;
    font-size: 15px !important;
    box-sizing: border-box !important;
    display: block !important;
    margin: 0 0 10px 0 !important;
}

/* Partial payment wrapper */
.gpo-partial-payment-wrapper,
.globo-preorder-app .gpo-partial-payment-wrapper {
    width: 100% !important;
    margin: 12px 0 0 0 !important;
    padding: 14px 16px !important;
    border: 1px solid #e2e8f0 !important;
    border-radius: 10px !important;
    background: #f8fafc !important;
    box-sizing: border-box !important;
    display: block !important;
}

.globo-preorder-app .gpo-partial-payment-choices {
    width: 100% !important;
    padding: 0 !important;
    margin: 8px 0 0 0 !important;
    list-style: none !important;
    display: block !important;
}

.globo-preorder-app .gpo-partial-payment-choices li {
    width: 100% !important;
    margin: 0 0 10px 0 !important;
    padding: 12px 14px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    border: 1px solid #dbe1ea !important;
    border-radius: 10px !important;
    background: #fff !important;
    box-sizing: border-box !important;
}

/* Mobile */
@media (max-width: 749px) {
    .gPreorderBtn,
    .gBackInStockBtn {
        padding: 0 20px !important;
        font-size: 15px !important;
        min-height: 50px !important;
        line-height: 50px !important;
    }
}
</style>
