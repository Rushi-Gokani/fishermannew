<script>
/**
 * Globo Pre-order Custom Configuration
 * Customized for product-page-modern.liquid template
 */
const preorderCustom = {
    render: function(){
        this.initSelectors();
        this.handleEvents();
    },
    initSelectors: function(){
        window.GloboPreorderParams = window.GloboPreorderParams || {};
        window.GloboPreorderParams.selectors = window.GloboPreorderParams.selectors || {};
        
        // Position hooks for pre-order/BIS form injection (primary placeholder + fallback on buttons row)
        window.GloboPreorderParams.selectors.productPositionBis = '.gPositionBis, .modern-product-actions';
        
        // Variant activators - elements that trigger variant changes
        if(window.GloboPreorderParams.selectors.productVariantActivator) {
            window.GloboPreorderParams.selectors.productVariantActivator += ", .modern-variant-swatch, .modern-variant-options input[type='radio'], input[name^='option']";
        } else {
            window.GloboPreorderParams.selectors.productVariantActivator = ".modern-variant-swatch, .modern-variant-options input[type='radio'], input[name^='option'], .product-form__single-selector";
        }
        
        // Product form selectors - multiple patterns to ensure detection
        window.GloboPreorderParams.selectors.productForm = "form.product-form, form[data-product-form], .modern-product-form__form";
        
        // Add to cart button selectors - must match your button
        window.GloboPreorderParams.selectors.productAddToCartBtn = window.GloboPreorderParams.selectors.productAddToCartBtn || [];
        if(Array.isArray(window.GloboPreorderParams.selectors.productAddToCartBtn)) {
            if(!window.GloboPreorderParams.selectors.productAddToCartBtn.includes('[data-action="add-to-cart"]')) {
                window.GloboPreorderParams.selectors.productAddToCartBtn.push('[data-action="add-to-cart"]');
            }
            if(!window.GloboPreorderParams.selectors.productAddToCartBtn.includes('.product-form__add-button')) {
                window.GloboPreorderParams.selectors.productAddToCartBtn.push('.product-form__add-button');
            }
            if(!window.GloboPreorderParams.selectors.productAddToCartBtn.includes('.modern-add-to-cart')) {
                window.GloboPreorderParams.selectors.productAddToCartBtn.push('.modern-add-to-cart');
            }
        }
        
        // Payment container
        window.GloboPreorderParams.selectors.productPaymentContainer = ".product-form__payment-container, .modern-atc-wrapper";
        
        // Quantity selector
        window.GloboPreorderParams.selectors.productQuantitySelector = ".quantity-selector__value, .modern-quantity-input, input[name='quantity']";
        
        // Collection/Quick view selectors
        window.GloboPreorderParams.selectors.collectionProductForms = ".product-item form, .product-card form";
        window.GloboPreorderParams.selectors.quickViewActivator = ".quick-add-btn, .product-item__action-button";
        window.GloboPreorderParams.selectors.quickViewProductForm = ".modal[aria-hidden=false] form, .quick-add-modal form";
        
        // Collection filter selectors
        if(window.GloboPreorderParams.selectors.collectionFilterSelector) {
            window.GloboPreorderParams.selectors.collectionFilterSelector += ", .collection__filter-checkbox label, .pagination__nav-item";
        }
        
        window.GloboPreorderParams.selectors.collectionAddToCartBtn = ".product-item__action-button, .quick-add-btn";
        
        console.log('[Globo Custom] Selectors initialized:', window.GloboPreorderParams.selectors);
    },
    handleEvents: function(){
        const app = this;

        // Handle variant changes
        document.addEventListener('globo.preorder.variant.changed', () => {
            app.appSetInterval(() => {
                let gSingleProductForm = document.querySelector('form.singleProductPreOrderForm');
                if(gSingleProductForm && window?.GloboPreorderParams?.page == 'product'){
                    if(window?.Globo?.Preorder) {
                        window.Globo.Preorder.renderProductForm && 
                            window.Globo.Preorder.renderProductForm(window.GloboPreorderParams.product);
                    }
                }
            }, 600, 2);
        });
      
        // Handle Back in Stock button showing
        document.addEventListener('globo.preorder.show.bis', function (e) {
            const {form, type} = e.detail;
            if(type === '#Globo-Back-In-Stock'){
                // Hide the regular add to cart button when BIS is shown
                const addToCartBtn = form.querySelector ? form.querySelector('[data-add-to-cart]') : form.find('[data-add-to-cart]');
                if(addToCartBtn) addToCartBtn.style.display = 'none';
            }
        });

        // Handle Add to Cart button showing (revert from pre-order state)
        document.addEventListener('globo.preorder.show.addtocart', function (e) {
            const {form, type} = e.detail;
            const addToCartBtn = form.querySelector ? form.querySelector('[data-add-to-cart]') : form.find('[data-add-to-cart]');
            if(addToCartBtn) addToCartBtn.style.display = '';
        });

        // Initialize on page load
        window.addEventListener('load', () => {
            app.handleVariantChange();
            window?.Globo?.Preorder && window.Globo.Preorder.initPreorder();
        });

        // Re-initialize on scroll for lazy-loaded content
        window.onscroll = app.debounce(() => {
            if(window?.GloboPreorderParams?.page == 'index' || window?.GloboPreorderParams?.page == 'collection'){
                window?.Globo?.Preorder && window.Globo.Preorder.initPreorder();
            }
        }, 1500);
    },
    handleVariantChange: function(){
        const app = this;
        
        // Listen to your modern theme's variant change events
        const variantSelectors = document.querySelectorAll('.modern-variant-swatch, .modern-variant-options input[type="radio"], input[name^="option"]');
        
        if(variantSelectors.length){
            variantSelectors.forEach(selector => {
                ['click', 'change'].forEach(action => {
                    selector.addEventListener(action, () => {
                        app.appSetInterval(() => {
                            if(window?.Globo?.Preorder){
                                window.Globo.Preorder.initPreorder();
                            }
                        }, 600, 2);
                    });
                });
            });
        }
    },
    appSetInterval: function(callback, interval, times) {
        callback();
        var count = 0;
        var intervalId = window.setInterval(function() {
            callback();
            if(++count === times) window.clearInterval(intervalId);
        }, interval);
    },
    debounce: function(func, timeout = 300){
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    }
};

// Initialize when DOM is ready
if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => preorderCustom.render());
} else {
    preorderCustom.render();
}
</script>

<style>
/* ========================================
   Globo Pre-order Custom Styles
   For Modern Product Page Integration
   ======================================== */

.gPreorderHidden {
    display: none !important;
}

/* ========== Main Layout Fixes ========== */
/* When preorder is active, hide the buttons row and show preorder in its place */
.gPreorderShowing .modern-buttons-row {
    display: none !important;
}

/* Hide quantity when preorder is showing - we'll show it inside preorder */
.gPreorderShowing .modern-quantity-selector {
    display: none !important;
}

/* ========== Layout & Container Fixes ========== */
/* Ensure Globo elements don't break the layout */
.modern-product-actions .gPositionBis {
    width: 100%;
    margin-top: 0;
}

/* Full width preorder container */
.gPreorderWrapper,
.gpo-form-wrapper,
.modern-product-form .gPreorderWrapper,
.product-form .gPreorderWrapper,
#Globo-Preorder-Form {
    width: 100% !important;
    margin: 0 !important;
    background: transparent !important;
    border: none !important;
    border-radius: 0 !important;
    padding: 0 !important;
    box-shadow: none !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 12px !important;
}

/* ========== Pre-order Heading ========== */
.gPreorderHeading,
.gpo-text-heading,
.globo-preorder-heading {
    font-size: 15px !important;
    font-weight: 600 !important;
    color: #e53935 !important;
    margin: 0 0 8px 0 !important;
    text-transform: none !important;
    text-align: left !important;
}

/* ========== Pre-order Content Row ========== */
/* Main row containing quantity + price/payment */
.gPreorderContentRow,
.gpo-price-row,
.globo-preorder-content-row {
    display: flex !important;
    align-items: stretch !important;
    gap: 10px !important;
    width: 100% !important;
}

/* Quantity selector inside preorder */
.gPreorderQuantity,
.globo-preorder-quantity {
    flex-shrink: 0 !important;
    width: 120px !important;
    min-width: 120px !important;
}

.gPreorderQuantity input,
.globo-preorder-quantity input {
    width: 100% !important;
    text-align: center !important;
    height: 48px !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 10px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
}

/* Price and payment container */
.gPreorderPriceSection,
.globo-preorder-price-section {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    min-width: 0 !important;
}

/* Price label */
.gPreorderPriceLabel,
.gpo-price-label,
.globo-preorder-price-label {
    font-size: 13px !important;
    font-weight: 500 !important;
    color: #64748b !important;
    margin: 0 !important;
}

/* Price amount */
.gPreorderPrice,
.gpo-price,
.globo-preorder-price {
    font-size: 24px !important;
    font-weight: 700 !important;
    color: #101828 !important;
    margin: 0 !important;
    line-height: 1.2 !important;
}

.gPreorderPrice small,
.gPreorderPrice span,
.gpo-price small,
.gpo-price span {
    font-size: 14px !important;
    font-weight: 500 !important;
    color: #475467 !important;
}

/* ========== Partial Payment Section ========== */
.modern-product-form .gPreorderPartialPaymentWrapper,
.product-form .gPreorderPartialPaymentWrapper,
.gpo-partial-payment-wrapper,
.globo-preorder-partial-wrapper {
    width: 100% !important;
    margin: 0 !important;
    padding: 14px 16px !important;
    border: 1px solid #e2e8f0 !important;
    border-radius: 10px !important;
    background: #f8fafc !important;
}

.modern-product-form .gPreorderPartialPaymentChoices,
.product-form .gPreorderPartialPaymentChoices,
.gpo-partial-payment-choices,
.globo-preorder-payment-choices {
    width: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
    list-style: none !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
}

.modern-product-form .gPreorderPartialPaymentChoices li,
.product-form .gPreorderPartialPaymentChoices li,
.gpo-payment-option,
.globo-preorder-payment-option {
    width: 100% !important;
    margin: 0 !important;
    padding: 12px 14px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    gap: 12px !important;
    border: 1px solid #dbe1ea !important;
    border-radius: 10px !important;
    background: #fff !important;
    cursor: pointer !important;
}

.gPreorderPartialPaymentLabel,
.gpo-payment-label,
.globo-preorder-payment-label {
    display: flex !important;
    flex-direction: column !important;
    gap: 2px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    color: #111827 !important;
    text-align: left !important;
}

.gPreorderPartialPaymentLabel span,
.gPreorderPartialPaymentLabel small,
.gpo-payment-label span,
.gpo-payment-label small {
    font-size: 12px !important;
    font-weight: 400 !important;
    color: #64748b !important;
}

.gPreorderPartialPaymentInput,
.gpo-radio input[type='radio'],
.globo-preorder-radio input[type='radio'] {
    flex-shrink: 0 !important;
    accent-color: #D32F2F !important;
    width: 18px !important;
    height: 18px !important;
    cursor: pointer !important;
}

/* ========== Pre-order Button ========== */
.gPreorderBtn,
.modern-product-form .gPreorderBtn,
.product-form .gPreorderBtn,
form.product-form button.gPreorderBtn,
.globo-preorder-btn {
    background: #D32F2F !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 0 24px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    width: 100% !important;
    min-height: 52px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 4px 12px rgb(211 47 47 / 0.3) !important;
}

.gPreorderBtn:hover:not(:disabled),
.modern-product-form .gPreorderBtn:hover:not(:disabled),
.product-form .gPreorderBtn:hover:not(:disabled) {
    background: #B71C1C !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 6px 16px rgb(211 47 47 / 0.4) !important;
}

/* ========== Back in Stock Button ========== */
.gBackInStockBtn,
#Globo-Back-In-Stock .gBackInStockBtn,
.globo-backinstock-btn {
    animation: gpo-glowing 1500ms infinite;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0.5rem;
    background: #40C4FF !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 0 24px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    width: 100% !important;
    min-height: 52px !important;
    box-shadow: 0 4px 12px rgb(64 196 255 / 0.3) !important;
}

.gBackInStockBtn svg {
    animation: gpo-shaking 0.5s infinite;
}

@keyframes gpo-glowing {
    0% { background-color: #40C4FF; box-shadow: 0 0 5px #40C4FF; }
    50% { background-color: #0288D1; box-shadow: 0 0 15px #0288D1; }
    100% { background-color: #40C4FF; box-shadow: 0 0 5px #40C4FF; }
}

@keyframes gpo-shaking {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(5deg); }
    50% { transform: rotate(0deg); }
    75% { transform: rotate(-5deg); }
    100% { transform: rotate(0deg); }
}

/* ========== Sold out state ========== */
.gSoldout {
    background: #f5f5f5 !important;
    color: #999 !important;
    border: 1px solid #ddd !important;
    opacity: .8 !important;
    pointer-events: none !important;
    cursor: not-allowed !important;
}

/* ========== Back in Stock Form ========== */
#Globo-Back-In-Stock {
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
}

#Globo-Back-In-Stock form {
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
}

#Globo-Back-In-Stock input[type="email"],
#Globo-Back-In-Stock input[type="text"] {
    width: 100% !important;
    padding: 14px 16px !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 10px !important;
    font-size: 15px !important;
}

/* ========== Hide/Show Behavior ========== */
/* Hide add to cart when pre-order or BIS is active */
.gBisShowing [data-add-to-cart],
.gBisShowing .modern-add-to-cart {
    display: none !important;
}

/* Hide empty position hook */
.gPositionBis:empty {
    display: none !important;
}

/* ========== Message Styling ========== */
.gPreorderMessage,
.gPreorderDeliveryDate,
.gpo-delivery-date,
.globo-preorder-message {
    font-size: 13px !important;
    color: #64748b !important;
    margin: 4px 0 0 0 !important;
    line-height: 1.5 !important;
}

.gPreorderDeliveryDate,
.gpo-delivery-date {
    color: #D32F2F !important;
    font-weight: 500 !important;
}

/* ========== Hide Learn More Link if exists ========== */
.gpo-learn-more,
.globo-preorder-learn-more {
    display: none !important;
}

/* ========== Mobile Responsive ========== */
@media (max-width: 749px) {
    .gPreorderBtn,
    .gBackInStockBtn {
        padding: 0 20px !important;
        font-size: 15px !important;
        min-height: 50px !important;
    }

    .gPreorderContentRow,
    .gpo-price-row {
        flex-direction: column !important;
        gap: 8px !important;
    }

    .gPreorderQuantity,
    .globo-preorder-quantity {
        width: 100% !important;
    }
}
</style>
