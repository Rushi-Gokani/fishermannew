<script>
/**
 * Globo Pre-order Custom Configuration
 * Fixed for consistent preorder button display
 * Uses Promise-based waiting and proper event handling
 */
(function() {
    'use strict';

    // Global state
    window.GloboPreorderCustomState = {
        initialized: false,
        globoReady: false,
        productData: null,
        retryCount: 0,
        maxRetries: 50,
        observers: []
    };

    // Wait for an element or condition with timeout
    function waitForCondition(condition, timeout = 30000) {
        return new Promise((resolve, reject) => {
            const startTime = Date.now();

            function check() {
                if (condition()) {
                    resolve(true);
                    return;
                }

                if (Date.now() - startTime > timeout) {
                    reject(new Error('Timeout waiting for condition'));
                    return;
                }

                requestAnimationFrame(check);
            }

            check();
        });
    }

    // Load product data from available JSON scripts
    function loadProductData() {
        if (window.GloboPreorderCustomState.productData) {
            return window.GloboPreorderCustomState.productData;
        }

        const scripts = document.querySelectorAll('script[data-product-json], script[data-globo-preorder-product]');
        for (let script of scripts) {
            try {
                const data = JSON.parse(script.textContent);
                if (data && data.id) {
                    window.GloboPreorderCustomState.productData = data;
                    window.GloboPreorderParams = window.GloboPreorderParams || {};
                    window.GloboPreorderParams.product = data;
                    window.GloboPreorderParams.page = 'product';
                    console.log('[Globo] Product loaded:', data.id);
                    return data;
                }
            } catch (e) {}
        }
        return null;
    }

    // Initialize selectors once
    function initSelectors() {
        window.GloboPreorderParams = window.GloboPreorderParams || {};
        window.GloboPreorderParams.selectors = window.GloboPreorderParams.selectors || {};
        window.GloboPreorderParams.page = 'product';

        window.GloboPreorderParams.selectors.productPositionBis = '.gPositionBis, .modern-globo-preorder-container, .globo-preorder-bis-hook';
        window.GloboPreorderParams.selectors.productForm = "form.product-form, form[data-product-form], .modern-product-form__form, .singleProductPreOrderForm, product-form form";

        const addToCartSelectors = ['[data-action="add-to-cart"]', '.product-form__add-button', '.modern-add-to-cart', '[name="add"]'];
        if (!Array.isArray(window.GloboPreorderParams.selectors.productAddToCartBtn)) {
            window.GloboPreorderParams.selectors.productAddToCartBtn = [];
        }
        addToCartSelectors.forEach(s => {
            if (!window.GloboPreorderParams.selectors.productAddToCartBtn.includes(s)) {
                window.GloboPreorderParams.selectors.productAddToCartBtn.push(s);
            }
        });

        window.GloboPreorderParams.selectors.productPaymentContainer = ".product-form__payment-container, .modern-atc-wrapper";
        window.GloboPreorderParams.selectors.productQuantitySelector = ".quantity-selector__value, .modern-quantity-input, input[name='quantity']";

        console.log('[Globo] Selectors initialized');
    }

    // Main refresh function - tries all possible methods
    function refreshPreorder(source = 'unknown') {
        if (!window.Globo || !window.Globo.Preorder) {
            console.log('[Globo] Not ready, skipping refresh from:', source);
            return;
        }

        console.log('[Globo] Refreshing from:', source);

        // Load fresh product data
        loadProductData();

        // Try all available methods
        const methods = Object.keys(window.Globo.Preorder).filter(k => typeof window.Globo.Preorder[k] === 'function');
        console.log('[Globo] Available methods:', methods);

        // Priority order of methods to try
        const priorityMethods = ['initPreorder', 'render', 'renderProductForm', 'renderProductByForm', 'init', 'load'];

        for (let method of priorityMethods) {
            if (methods.includes(method)) {
                try {
                    console.log('[Globo] Calling:', method);

                    if (method === 'renderProductForm' && window.GloboPreorderParams?.product) {
                        window.Globo.Preorder[method](window.GloboPreorderParams.product);
                    } else if (method === 'renderProductByForm') {
                        const form = document.querySelector('.singleProductPreOrderForm, .modern-product-form__form');
                        if (form) window.Globo.Preorder[method](form);
                    } else {
                        window.Globo.Preorder[method]();
                    }
                } catch (e) {
                    console.warn('[Globo] Method', method, 'error:', e.message);
                }
            }
        }

        // Trigger custom event
        document.dispatchEvent(new CustomEvent('globo.preorder.variant.changed', {
            detail: { product: window.GloboPreorderParams?.product }
        }));

        // Log state
        const gPos = document.querySelector('.gPositionBis');
        console.log('[Globo] State:', {
            gPositionBis: !!gPos,
            hasContent: gPos ? gPos.innerHTML.length > 0 : false,
            content: gPos ? gPos.innerHTML.substring(0, 50) : 'N/A'
        });
    }

    // Set up variant change listeners
    function setupVariantListeners() {
        // Use event delegation with capture phase
        document.addEventListener('change', function(e) {
            const target = e.target;
            if (target.matches('input[type="radio"], input[name^="option"], select[name="id"]') ||
                target.closest('.modern-variant-swatch') ||
                target.closest('variant-picker')) {
                console.log('[Globo] Variant changed');
                refreshPreorder('variant-change');
            }
        }, true);

        document.addEventListener('click', function(e) {
            const target = e.target;
            if (target.matches('.modern-variant-swatch, .modern-variant-swatch *') ||
                target.closest('.modern-variant-swatch')) {
                console.log('[Globo] Variant clicked');
                setTimeout(() => refreshPreorder('variant-click'), 100);
            }
        }, true);
    }

    // Set up mutation observer for DOM changes
    function setupMutationObserver() {
        const observer = new MutationObserver((mutations) => {
            for (let mutation of mutations) {
                if (mutation.type === 'childList') {
                    for (let node of mutation.addedNodes) {
                        if (node.nodeType === 1 && (
                            node.classList?.contains('gPositionBis') ||
                            node.classList?.contains('modern-variant-swatch') ||
                            node.querySelector?.('.gPositionBis') ||
                            node.querySelector?.('.modern-variant-swatch')
                        )) {
                            refreshPreorder('dom-mutation');
                            break;
                        }
                    }
                }
            }
        });

        // Start observing when form exists
        const startObserving = () => {
            const form = document.querySelector('.modern-product-form__form, .singleProductPreOrderForm');
            if (form) {
                observer.observe(form, { childList: true, subtree: true });
                console.log('[Globo] MutationObserver attached');
            } else {
                setTimeout(startObserving, 500);
            }
        };
        startObserving();
    }

    // Main initialization
    async function init() {
        console.log('[Globo] Starting initialization...');

        // Initialize selectors immediately
        initSelectors();
        loadProductData();
        setupVariantListeners();
        setupMutationObserver();

        // Wait for Globo to be ready
        try {
            await waitForCondition(() => window.Globo && window.Globo.Preorder, 15000);
            console.log('[Globo] Globo.Preorder is ready!');

            window.GloboPreorderCustomState.globoReady = true;

            // Initial refresh
            refreshPreorder('initial');

            // Set up periodic checks (debounced)
            let lastCheck = 0;
            setInterval(() => {
                const now = Date.now();
                if (now - lastCheck > 3000) {
                    lastCheck = now;
                    const gPos = document.querySelector('.gPositionBis');
                    if (gPos && gPos.innerHTML.length === 0) {
                        console.log('[Globo] Periodic: gPositionBis empty, refreshing');
                        refreshPreorder('periodic');
                    }
                }
            }, 5000);

        } catch (e) {
            console.error('[Globo] Failed to initialize:', e.message);
        }
    }

    // Start initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Also try on window load
    window.addEventListener('load', () => {
        setTimeout(() => refreshPreorder('window-load'), 500);
        setTimeout(() => refreshPreorder('window-load-delayed'), 1500);
    });

    // Export helper
    window.GloboPreorderCustom = {
        refresh: refreshPreorder,
        init: init
    };

    console.log('[Globo] Custom script loaded');
})();
</script>

<style>
/* ========================================
   Globo Pre-order Custom Styles
   For Modern Product Page Integration
   ======================================== */

/* Main Container - RESET EVERYTHING */
.gPositionBis,
.modern-globo-preorder-container,
.globo-preorder-bis-hook {
    width: 100% !important;
    max-width: 100% !important;
    margin: 12px 0 0 0 !important;
    padding: 0 !important;
    display: block !important;
    box-sizing: border-box !important;
    clear: both !important;
    float: none !important;
    position: relative !important;
    visibility: visible !important;
    opacity: 1 !important;
    text-align: left !important;
    line-height: normal !important;
    font-size: inherit !important;
    font-family: inherit !important;
}

/* Override any inline styles from Globo */
.gPositionBis[style],
.modern-globo-preorder-container[style],
.globo-preorder-bis-hook[style],
.gPositionBis *[style],
.modern-globo-preorder-container *[style],
.globo-preorder-bis-hook *[style] {
    max-width: 100% !important;
    box-sizing: border-box !important;
    float: none !important;
    position: relative !important;
    left: auto !important;
    right: auto !important;
    top: auto !important;
    bottom: auto !important;
}

/* Force all direct children to behave */
.gPositionBis > *,
.modern-globo-preorder-container > *,
.globo-preorder-bis-hook > * {
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    margin: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding: 0 !important;
    float: none !important;
    clear: both !important;
    text-align: left !important;
}

/* Override specific Globo elements */
.gPositionBis .globo-preorder-app,
.gPositionBis .gpo-form-wrapper,
.gPositionBis .gPreorderWrapper,
.gPositionBis #Globo-Preorder-Form,
.gPositionBis #Globo-Back-In-Stock {
    width: 100% !important;
    max-width: 100% !important;
    display: block !important;
    box-sizing: border-box !important;
    margin: 0 !important;
    padding: 0 !important;
    float: none !important;
    position: relative !important;
    left: auto !important;
    right: auto !important;
}

/* Pre-order Button - CLEAN STYLES */
.gPreorderBtn,
.modern-product-form .gPreorderBtn,
.product-form .gPreorderBtn,
form.product-form button.gPreorderBtn,
.gPositionBis button,
.gPositionBis .gPreorderBtn {
    background: #D32F2F !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 16px 24px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    width: 100% !important;
    max-width: 100% !important;
    min-height: 52px !important;
    height: auto !important;
    display: block !important;
    line-height: 1.4 !important;
    text-align: center !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3) !important;
    float: none !important;
    margin: 0 !important;
    position: relative !important;
    left: auto !important;
    top: auto !important;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
}

.gPreorderBtn:hover:not(:disabled) {
    background: #B71C1C !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 6px 16px rgba(211, 47, 47, 0.4) !important;
}

.gPreorderBtn:active:not(:disabled) {
    transform: translateY(0) !important;
}

/* Back in Stock Button */
.gBackInStockBtn,
#Globo-Back-In-Stock .gBackInStockBtn,
.gPositionBis .gBackInStockBtn {
    animation: gpo-glowing 1500ms infinite !important;
    display: block !important;
    text-align: center !important;
    background: #40C4FF !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 16px 24px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    width: 100% !important;
    max-width: 100% !important;
    min-height: 52px !important;
    height: auto !important;
    line-height: 1.4 !important;
    box-shadow: 0 4px 12px rgba(64, 196, 255, 0.3) !important;
    float: none !important;
    margin: 0 !important;
    position: relative !important;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
}

.gBackInStockBtn svg {
    display: inline-block !important;
    vertical-align: middle !important;
    margin-right: 8px !important;
}

@keyframes gpo-glowing {
    0% { background-color: #40C4FF; box-shadow: 0 0 5px #40C4FF; }
    50% { background-color: #0288D1; box-shadow: 0 0 15px #0288D1; }
    100% { background-color: #40C4FF; box-shadow: 0 0 5px #40C4FF; }
}

/* Back in Stock Form */
#Globo-Back-In-Stock,
.gPositionBis #Globo-Back-In-Stock {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    display: block !important;
    margin: 0 !important;
    padding: 0 !important;
    float: none !important;
    position: relative !important;
}

#Globo-Back-In-Stock form,
.gPositionBis #Globo-Back-In-Stock form {
    display: block !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

#Globo-Back-In-Stock input[type="email"],
#Globo-Back-In-Stock input[type="text"],
.gPositionBis input[type="email"],
.gPositionBis input[type="text"] {
    width: 100% !important;
    max-width: 100% !important;
    padding: 14px 16px !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 10px !important;
    font-size: 15px !important;
    box-sizing: border-box !important;
    display: block !important;
    margin: 0 0 12px 0 !important;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
}

/* Preorder wrapper/heading */
.gpo-text-heading,
.globo-preorder-app .gpo-heading,
.gPreorderHeading,
.gPositionBis .gpo-text-heading,
.gPositionBis .gpo-heading {
    display: block !important;
    width: 100% !important;
    font-size: 15px !important;
    font-weight: 600 !important;
    color: #e53935 !important;
    margin: 0 0 12px 0 !important;
    padding: 0 !important;
    text-align: left !important;
    line-height: 1.4 !important;
}

/* Price display */
.gpo-price,
.globo-preorder-app .gpo-price,
.gPositionBis .gpo-price {
    display: block !important;
    width: 100% !important;
    font-size: 24px !important;
    font-weight: 700 !important;
    color: #101828 !important;
    margin: 0 0 12px 0 !important;
    padding: 0 !important;
}

.gpo-price-label,
.globo-preorder-app .gpo-price-label,
.gPositionBis .gpo-price-label {
    display: block !important;
    font-size: 13px !important;
    font-weight: 500 !important;
    color: #64748b !important;
    margin: 0 0 4px 0 !important;
}

/* Partial payment section */
.gpo-partial-payment-wrapper,
.globo-preorder-app .gpo-partial-payment-wrapper,
.gPositionBis .gpo-partial-payment-wrapper {
    width: 100% !important;
    display: block !important;
    margin: 16px 0 0 0 !important;
    padding: 16px !important;
    border: 1px solid #e2e8f0 !important;
    border-radius: 10px !important;
    background: #f8fafc !important;
    box-sizing: border-box !important;
}

.gpo-partial-payment-choices,
.globo-preorder-app .gpo-partial-payment-choices,
.gPositionBis .gpo-partial-payment-choices {
    width: 100% !important;
    display: block !important;
    margin: 12px 0 0 0 !important;
    padding: 0 !important;
    list-style: none !important;
}

.gpo-partial-payment-choices li,
.globo-preorder-app .gpo-partial-payment-choices li,
.gPositionBis .gpo-partial-payment-choices li {
    width: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    margin: 0 0 10px 0 !important;
    padding: 12px 14px !important;
    border: 1px solid #dbe1ea !important;
    border-radius: 10px !important;
    background: #fff !important;
    box-sizing: border-box !important;
}

.gpo-partial-payment-choices li:last-child {
    margin-bottom: 0 !important;
}

/* Payment label */
.gpo-payment-label,
.globo-preorder-app .gpo-payment-label,
.gPositionBis .gpo-payment-label {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: #111827 !important;
    display: block !important;
}

.gpo-payment-label span,
.gpo-payment-label small,
.gPositionBis .gpo-payment-label span,
.gPositionBis .gpo-payment-label small {
    font-size: 12px !important;
    font-weight: 400 !important;
    color: #64748b !important;
}

/* Radio inputs */
.gpo-radio input[type="radio"],
.gPositionBis .gpo-radio input[type="radio"],
.globo-preorder-app .gpo-radio input[type="radio"] {
    width: 18px !important;
    height: 18px !important;
    accent-color: #D32F2F !important;
    margin: 0 !important;
}

/* Message text */
.gpo-message,
.globo-preorder-app .gpo-message,
.gPreorderMessage,
.gPositionBis .gpo-message {
    display: block !important;
    width: 100% !important;
    font-size: 13px !important;
    color: #64748b !important;
    margin: 12px 0 0 0 !important;
    line-height: 1.5 !important;
}

/* Hide empty placeholder */
.gPositionBis:empty {
    display: none !important;
}

/* Reset all possible layout-breaking properties */
.gPositionBis *[style*="float"],
.gPositionBis *[style*="position: absolute"],
.gPositionBis *[style*="position: fixed"] {
    float: none !important;
    position: relative !important;
    left: auto !important;
    right: auto !important;
    top: auto !important;
    bottom: auto !important;
}

/* Mobile */
@media (max-width: 749px) {
    .gPreorderBtn,
    .gBackInStockBtn {
        padding: 14px 20px !important;
        font-size: 15px !important;
        min-height: 50px !important;
    }
}
</style>
