{% comment %} <script>
/**
 * Globo Pre-order Custom Configuration
 * Fixed for consistent preorder button display
 * Uses Promise-based waiting and proper event handling
 */
(function() {
    'use strict';

    // Global state
    window.GloboPreorderCustomState = {
        initialized: false,
        globoReady: false,
        productData: null,
        retryCount: 0,
        maxRetries: 50,
        observers: []
    };

    // Wait for an element or condition with timeout
    function waitForCondition(condition, timeout = 30000) {
        return new Promise((resolve, reject) => {
            const startTime = Date.now();

            function check() {
                if (condition()) {
                    resolve(true);
                    return;
                }

                if (Date.now() - startTime > timeout) {
                    reject(new Error('Timeout waiting for condition'));
                    return;
                }

                requestAnimationFrame(check);
            }

            check();
        });
    }

    // Load product data from available JSON scripts
    function loadProductData() {
        if (window.GloboPreorderCustomState.productData) {
            return window.GloboPreorderCustomState.productData;
        }

        const scripts = document.querySelectorAll('script[data-product-json], script[data-globo-preorder-product]');
        for (let script of scripts) {
            try {
                const data = JSON.parse(script.textContent);
                if (data && data.id) {
                    window.GloboPreorderCustomState.productData = data;
                    window.GloboPreorderParams = window.GloboPreorderParams || {};
                    window.GloboPreorderParams.product = data;
                    window.GloboPreorderParams.page = 'product';
                    console.log('[Globo] Product loaded:', data.id);
                    return data;
                }
            } catch (e) {}
        }
        return null;
    }

    // Initialize selectors once
    function initSelectors() {
        window.GloboPreorderParams = window.GloboPreorderParams || {};
        window.GloboPreorderParams.selectors = window.GloboPreorderParams.selectors || {};
        window.GloboPreorderParams.page = 'product';

        window.GloboPreorderParams.selectors.productPositionBis = '.gPositionBis, .modern-globo-preorder-container, .globo-preorder-bis-hook';
        window.GloboPreorderParams.selectors.productForm = "form.product-form, form[data-product-form], .modern-product-form__form, .singleProductPreOrderForm, product-form form";

        const addToCartSelectors = ['[data-action="add-to-cart"]', '.product-form__add-button', '.modern-add-to-cart', '[name="add"]'];
        if (!Array.isArray(window.GloboPreorderParams.selectors.productAddToCartBtn)) {
            window.GloboPreorderParams.selectors.productAddToCartBtn = [];
        }
        addToCartSelectors.forEach(s => {
            if (!window.GloboPreorderParams.selectors.productAddToCartBtn.includes(s)) {
                window.GloboPreorderParams.selectors.productAddToCartBtn.push(s);
            }
        });

        window.GloboPreorderParams.selectors.productPaymentContainer = ".product-form__payment-container, .modern-atc-wrapper";
        window.GloboPreorderParams.selectors.productQuantitySelector = ".quantity-selector__value, .modern-quantity-input, input[name='quantity']";

        console.log('[Globo] Selectors initialized');
    }

    // Main refresh function - tries all possible methods
    function refreshPreorder(source = 'unknown') {
        if (!window.Globo || !window.Globo.Preorder) {
            console.log('[Globo] Not ready, skipping refresh from:', source);
            return;
        }

        console.log('[Globo] Refreshing from:', source);

        // Load fresh product data
        loadProductData();

        // Try all available methods
        const methods = Object.keys(window.Globo.Preorder).filter(k => typeof window.Globo.Preorder[k] === 'function');
        console.log('[Globo] Available methods:', methods);

        // Priority order of methods to try
        const priorityMethods = ['initPreorder', 'render', 'renderProductForm', 'renderProductByForm', 'init', 'load'];

        for (let method of priorityMethods) {
            if (methods.includes(method)) {
                try {
                    console.log('[Globo] Calling:', method);

                    if (method === 'renderProductForm' && window.GloboPreorderParams?.product) {
                        window.Globo.Preorder[method](window.GloboPreorderParams.product);
                    } else if (method === 'renderProductByForm') {
                        const form = document.querySelector('.singleProductPreOrderForm, .modern-product-form__form');
                        if (form) window.Globo.Preorder[method](form);
                    } else {
                        window.Globo.Preorder[method]();
                    }
                } catch (e) {
                    console.warn('[Globo] Method', method, 'error:', e.message);
                }
            }
        }

        // Trigger custom event
        document.dispatchEvent(new CustomEvent('globo.preorder.variant.changed', {
            detail: { product: window.GloboPreorderParams?.product }
        }));

        // Log state
        const gPos = document.querySelector('.gPositionBis');
        console.log('[Globo] State:', {
            gPositionBis: !!gPos,
            hasContent: gPos ? gPos.innerHTML.length > 0 : false,
            content: gPos ? gPos.innerHTML.substring(0, 50) : 'N/A'
        });
    }

    // Set up variant change listeners
    function setupVariantListeners() {
        // Use event delegation with capture phase
        document.addEventListener('change', function(e) {
            const target = e.target;
            if (target.matches('input[type="radio"], input[name^="option"], select[name="id"]') ||
                target.closest('.modern-variant-swatch') ||
                target.closest('variant-picker')) {
                console.log('[Globo] Variant changed');
                refreshPreorder('variant-change');
            }
        }, true);

        document.addEventListener('click', function(e) {
            const target = e.target;
            if (target.matches('.modern-variant-swatch, .modern-variant-swatch *') ||
                target.closest('.modern-variant-swatch')) {
                console.log('[Globo] Variant clicked');
                setTimeout(() => refreshPreorder('variant-click'), 100);
            }
        }, true);
    }

    // Set up mutation observer for DOM changes
    function setupMutationObserver() {
        const observer = new MutationObserver((mutations) => {
            for (let mutation of mutations) {
                if (mutation.type === 'childList') {
                    for (let node of mutation.addedNodes) {
                        if (node.nodeType === 1 && (
                            node.classList?.contains('gPositionBis') ||
                            node.classList?.contains('modern-variant-swatch') ||
                            node.querySelector?.('.gPositionBis') ||
                            node.querySelector?.('.modern-variant-swatch')
                        )) {
                            refreshPreorder('dom-mutation');
                            break;
                        }
                    }
                }
            }
        });

        // Start observing when form exists
        const startObserving = () => {
            const form = document.querySelector('.modern-product-form__form, .singleProductPreOrderForm');
            if (form) {
                observer.observe(form, { childList: true, subtree: true });
                console.log('[Globo] MutationObserver attached');
            } else {
                setTimeout(startObserving, 500);
            }
        };
        startObserving();
    }

    // Main initialization
    async function init() {
        console.log('[Globo] Starting initialization...');

        // Initialize selectors immediately
        initSelectors();
        loadProductData();
        setupVariantListeners();
        setupMutationObserver();

        // Wait for Globo to be ready
        try {
            await waitForCondition(() => window.Globo && window.Globo.Preorder, 15000);
            console.log('[Globo] Globo.Preorder is ready!');

            window.GloboPreorderCustomState.globoReady = true;

            // Initial refresh
            refreshPreorder('initial');

            // Set up periodic checks (debounced)
            let lastCheck = 0;
            setInterval(() => {
                const now = Date.now();
                if (now - lastCheck > 3000) {
                    lastCheck = now;
                    const gPos = document.querySelector('.gPositionBis');
                    if (gPos && gPos.innerHTML.length === 0) {
                        console.log('[Globo] Periodic: gPositionBis empty, refreshing');
                        refreshPreorder('periodic');
                    }
                }
            }, 5000);

        } catch (e) {
            console.error('[Globo] Failed to initialize:', e.message);
        }
    }

    // Start initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Also try on window load
    window.addEventListener('load', () => {
        setTimeout(() => refreshPreorder('window-load'), 500);
        setTimeout(() => refreshPreorder('window-load-delayed'), 1500);
    });

    // Export helper
    window.GloboPreorderCustom = {
        refresh: refreshPreorder,
        init: init
    };

    console.log('[Globo] Custom script loaded');
})();
</script>

<style>
/* ========================================
   Globo Pre-order Custom Styles
   For Modern Product Page Integration
   ======================================== */

/* Main Container - RESET EVERYTHING */
.gPositionBis,
.modern-globo-preorder-container,
.globo-preorder-bis-hook {
    width: 100% !important;
    max-width: 100% !important;
    margin: 12px 0 0 0 !important;
    padding: 0 !important;
    display: block !important;
    box-sizing: border-box !important;
    clear: both !important;
    float: none !important;
    position: relative !important;
    visibility: visible !important;
    opacity: 1 !important;
    text-align: left !important;
    line-height: normal !important;
    font-size: inherit !important;
    font-family: inherit !important;
}

/* Override any inline styles from Globo */
.gPositionBis[style],
.modern-globo-preorder-container[style],
.globo-preorder-bis-hook[style],
.gPositionBis *[style],
.modern-globo-preorder-container *[style],
.globo-preorder-bis-hook *[style] {
    max-width: 100% !important;
    box-sizing: border-box !important;
    float: none !important;
    position: relative !important;
    left: auto !important;
    right: auto !important;
    top: auto !important;
    bottom: auto !important;
}

/* Force all direct children to behave */
.gPositionBis > *,
.modern-globo-preorder-container > *,
.globo-preorder-bis-hook > * {
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    margin: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding: 0 !important;
    float: none !important;
    clear: both !important;
    text-align: left !important;
}

/* Override specific Globo elements */
.gPositionBis .globo-preorder-app,
.gPositionBis .gpo-form-wrapper,
.gPositionBis .gPreorderWrapper,
.gPositionBis #Globo-Preorder-Form,
.gPositionBis #Globo-Back-In-Stock {
    width: 100% !important;
    max-width: 100% !important;
    display: block !important;
    box-sizing: border-box !important;
    margin: 0 !important;
    padding: 0 !important;
    float: none !important;
    position: relative !important;
    left: auto !important;
    right: auto !important;
}

/* Pre-order Button - CLEAN STYLES */
.gPreorderBtn,
.modern-product-form .gPreorderBtn,
.product-form .gPreorderBtn,
form.product-form button.gPreorderBtn,
.gPositionBis button,
.gPositionBis .gPreorderBtn {
    background: #D32F2F !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 16px 24px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    width: 100% !important;
    max-width: 100% !important;
    min-height: 52px !important;
    height: auto !important;
    display: block !important;
    line-height: 1.4 !important;
    text-align: center !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3) !important;
    float: none !important;
    margin: 0 !important;
    position: relative !important;
    left: auto !important;
    top: auto !important;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
}

.gPreorderBtn:hover:not(:disabled) {
    background: #B71C1C !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 6px 16px rgba(211, 47, 47, 0.4) !important;
}

.gPreorderBtn:active:not(:disabled) {
    transform: translateY(0) !important;
}

/* Back in Stock Button */
.gBackInStockBtn,
#Globo-Back-In-Stock .gBackInStockBtn,
.gPositionBis .gBackInStockBtn {
    animation: gpo-glowing 1500ms infinite !important;
    display: block !important;
    text-align: center !important;
    background: #40C4FF !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 16px 24px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    width: 100% !important;
    max-width: 100% !important;
    min-height: 52px !important;
    height: auto !important;
    line-height: 1.4 !important;
    box-shadow: 0 4px 12px rgba(64, 196, 255, 0.3) !important;
    float: none !important;
    margin: 0 !important;
    position: relative !important;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
}

.gBackInStockBtn svg {
    display: inline-block !important;
    vertical-align: middle !important;
    margin-right: 8px !important;
}

@keyframes gpo-glowing {
    0% { background-color: #40C4FF; box-shadow: 0 0 5px #40C4FF; }
    50% { background-color: #0288D1; box-shadow: 0 0 15px #0288D1; }
    100% { background-color: #40C4FF; box-shadow: 0 0 5px #40C4FF; }
}

/* Back in Stock Form */
#Globo-Back-In-Stock,
.gPositionBis #Globo-Back-In-Stock {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    display: block !important;
    margin: 0 !important;
    padding: 0 !important;
    float: none !important;
    position: relative !important;
}

#Globo-Back-In-Stock form,
.gPositionBis #Globo-Back-In-Stock form {
    display: block !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

#Globo-Back-In-Stock input[type="email"],
#Globo-Back-In-Stock input[type="text"],
.gPositionBis input[type="email"],
.gPositionBis input[type="text"] {
    width: 100% !important;
    max-width: 100% !important;
    padding: 14px 16px !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 10px !important;
    font-size: 15px !important;
    box-sizing: border-box !important;
    display: block !important;
    margin: 0 0 12px 0 !important;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
}

/* Preorder wrapper/heading */
.gpo-text-heading,
.globo-preorder-app .gpo-heading,
.gPreorderHeading,
.gPositionBis .gpo-text-heading,
.gPositionBis .gpo-heading {
    display: block !important;
    width: 100% !important;
    font-size: 15px !important;
    font-weight: 600 !important;
    color: #e53935 !important;
    margin: 0 0 12px 0 !important;
    padding: 0 !important;
    text-align: left !important;
    line-height: 1.4 !important;
}

/* Price display */
.gpo-price,
.globo-preorder-app .gpo-price,
.gPositionBis .gpo-price {
    display: block !important;
    width: 100% !important;
    font-size: 24px !important;
    font-weight: 700 !important;
    color: #101828 !important;
    margin: 0 0 12px 0 !important;
    padding: 0 !important;
}

.gpo-price-label,
.globo-preorder-app .gpo-price-label,
.gPositionBis .gpo-price-label {
    display: block !important;
    font-size: 13px !important;
    font-weight: 500 !important;
    color: #64748b !important;
    margin: 0 0 4px 0 !important;
}

/* Partial payment section */
.gpo-partial-payment-wrapper,
.globo-preorder-app .gpo-partial-payment-wrapper,
.gPositionBis .gpo-partial-payment-wrapper {
    width: 100% !important;
    display: block !important;
    margin: 16px 0 0 0 !important;
    padding: 16px !important;
    border: 1px solid #e2e8f0 !important;
    border-radius: 10px !important;
    background: #f8fafc !important;
    box-sizing: border-box !important;
}

.gpo-partial-payment-choices,
.globo-preorder-app .gpo-partial-payment-choices,
.gPositionBis .gpo-partial-payment-choices {
    width: 100% !important;
    display: block !important;
    margin: 12px 0 0 0 !important;
    padding: 0 !important;
    list-style: none !important;
}

.gpo-partial-payment-choices li,
.globo-preorder-app .gpo-partial-payment-choices li,
.gPositionBis .gpo-partial-payment-choices li {
    width: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    margin: 0 0 10px 0 !important;
    padding: 12px 14px !important;
    border: 1px solid #dbe1ea !important;
    border-radius: 10px !important;
    background: #fff !important;
    box-sizing: border-box !important;
}

.gpo-partial-payment-choices li:last-child {
    margin-bottom: 0 !important;
}

/* Payment label */
.gpo-payment-label,
.globo-preorder-app .gpo-payment-label,
.gPositionBis .gpo-payment-label {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: #111827 !important;
    display: block !important;
}

.gpo-payment-label span,
.gpo-payment-label small,
.gPositionBis .gpo-payment-label span,
.gPositionBis .gpo-payment-label small {
    font-size: 12px !important;
    font-weight: 400 !important;
    color: #64748b !important;
}

/* Radio inputs */
.gpo-radio input[type="radio"],
.gPositionBis .gpo-radio input[type="radio"],
.globo-preorder-app .gpo-radio input[type="radio"] {
    width: 18px !important;
    height: 18px !important;
    accent-color: #D32F2F !important;
    margin: 0 !important;
}

/* Message text */
.gpo-message,
.globo-preorder-app .gpo-message,
.gPreorderMessage,
.gPositionBis .gpo-message {
    display: block !important;
    width: 100% !important;
    font-size: 13px !important;
    color: #64748b !important;
    margin: 12px 0 0 0 !important;
    line-height: 1.5 !important;
}

/* Hide empty placeholder */
.gPositionBis:empty {
    display: none !important;
}

/* Reset all possible layout-breaking properties */
.gPositionBis *[style*="float"],
.gPositionBis *[style*="position: absolute"],
.gPositionBis *[style*="position: fixed"] {
    float: none !important;
    position: relative !important;
    left: auto !important;
    right: auto !important;
    top: auto !important;
    bottom: auto !important;
}

/* Mobile */
@media (max-width: 749px) {
    .gPreorderBtn,
    .gBackInStockBtn {
        padding: 14px 20px !important;
        font-size: 15px !important;
        min-height: 50px !important;
    }
}
</style> {% endcomment %}
<script>
    window.GloboPreorderParams = window.GloboPreorderParams || {};
    window.GloboPreorderParams.selectors = window.GloboPreorderParams.selectors || {};
    window.GloboPreorderParams.selectors.productPositionLimitMessage = '.modern-product-actions-wrapper';
    window.GloboPreorderParams.selectors.productPositionMessage = '.modern-product-actions-wrapper';
    window.GloboPreorderParams.selectors.productPositionPaymentOption = '.modern-product-actions-wrapper';
    window.GloboPreorderParams.selectors.productPositionBis = '.gPositionBis';
    window.GloboPreorderParams.selectors.productPositionBis = '.gPositionBis';
    window.GloboPreorderParams.selectors.productVariantActivator += ", .swatch-anchor, .globo-swatch-list label, .globo-swatch-list select";
    window.GloboPreorderParams.selectors.collectionProductForms = ".product-item form.product-item__action-list, .gPreorderCollectionForm";
    window.GloboPreorderParams.selectors.quickViewActivator = ".product-item__action-button";
    window.GloboPreorderParams.selectors.quickViewProductForm = ".modal[aria-hidden=false] form.product-form";
    window.GloboPreorderParams.selectors.collectionFilterSelector += ", .collection__filter-checkbox label, .pagination__nav-item";
    window.GloboPreorderParams.selectors.collectionAddToCartBtn = ".product-item__action-button, .collectionPreorderAddToCartBtn";

    document.addEventListener('globo.preorder.variant.changed', () => {
        app.appSetInterval(() => {
            const gSingleProductForm = document.querySelector('form.singleProductPreOrderForm');
            if (gSingleProductForm && window?.GloboPreorderParams?.page === 'product') {
                app.renderProductForm(gSingleProductForm, window.GloboPreorderParams.product);
            }
        }, 600, 2);
    });

    document.addEventListener('globo.preorder.show.bis', function (e) {
        const { form, type } = e.detail;
        if (type === '#Globo-Back-In-Stock') {
            form.querySelector('.magic-buy-btn__parent')?.classList.add('gPreorderHidden');
        }

        form.classList.add('gBisShowing');
        if (form.classList.contains('gridProductPreOrderForm')) {
            const disabledBtn = form.querySelector('.product-item__action-button[disabled]');
            if (!disabledBtn) {
                form.querySelector('#Globo-Back-In-Stock')?.classList.add('gPreorderHidden');
            }
        }
    });

    document.addEventListener('globo.preorder.show.addtocart', function (e) {
        const { form } = e.detail;
        form.classList.remove('gBisShowing');
    });

    window.addEventListener('load', () => {
        app.handleVariantChange();
        if (window?.Globo?.Preorder) {
            window.Globo.Preorder.initPreorder();
        }
    });

    document.addEventListener('globo.preorder.show.naMessage', e => {
        const { form, profile } = e.detail;
        window.Globo.Preorder.appSetInterval(() => {
            if (form.classList.contains('singleProductPreOrderForm')) {
                const stickyBtn = document.querySelector('.zrx-sticky-atc-main-button');
                if (stickyBtn) {
                    stickyBtn.classList.add('gSoldout');
                    stickyBtn.innerHTML = profile.message.soldoutText;
                }
            }
        }, 600, 2);
    })

    window.onscroll = app.debounce(() => {
        if(window?.GloboPreorderParams?.page == 'index'){
            window?.Globo?.Preorder && window.Globo.Preorder.initPreorder()
        }
    }, 1500)


    const preorderCustom = {
        render: function(){
            this.initSelectors()
            this.handleEvents()
        },
        initSelectors: function(){
            
        },
        handleEvents: function(){
            const app = this;
            app.showPreorderButton()
            app.showAddToCartButton()
            app.handleUpdateCart()
        },
        handleFilterChange: function(){
            const app = this;
            let productNotLoadeds = document.querySelectorAll('.product-item:not([preorder-product-element])')

            if(productNotLoadeds.length && window?.Globo?.Preorder){
                window.Globo.Preorder.initPreorder()
            }

            let collectionFilterSelectors = document.querySelectorAll(window.GloboPreorderParams.selectors.collectionFilterSelector)

            if(collectionFilterSelectors.length){
                collectionFilterSelectors.forEach(collectionFilterSelector => {
                    ['click', 'change'].forEach(action => {
                        collectionFilterSelector.addEventListener(action, () => {
                            app.appSetInterval(() => {
                                app.handleFilterChange()
                            }, 2500, 2)
                        })
                    })
                })
            }
        },
        handleUpdateCart: function(){
            document.addEventListener('globo.preorder.update.cart', async () => {
                const response = await fetch("".concat(window.location.origin, "/cart.js"));
                    const jsonData = await response.json();

                    if(window?.GloboPreorderParams?.cart && window?.Globo?.Preorder){
                        window.GloboPreorderParams.cart = jsonData;
                        window.Globo.Preorder.initPreorder()
                    }

            })
        },
        handleVariantChange: function(){
            const app = this;
            let productVariantActivators = document.querySelectorAll(window.GloboPreorderParams.selectors.productVariantActivator)

            if(productVariantActivators.length){
                productVariantActivators.forEach(productVariantActivator => {
                    ['click', 'change'].forEach(action => {
                        productVariantActivator.addEventListener(action, () => {
                            app.appSetInterval(() => {
                                let gSingleProductForm = $('form.singleProductPreOrderForm')
                                if(gSingleProductForm.length && window?.GloboPreorderParams?.page == 'product'){
                                    app.renderProductForm(gSingleProductForm, window.GloboPreorderParams.product)
                                }
                            }, 600, 2)
                        })
                    })
                })
            }
        },
        renderProductForm: function(form, product) {
            const app = window.Globo.Preorder;
            const productVariantActivator = app.settings.selectors.productVariantActivator;
            const productVariantSelector = app.settings.selectors.productVariantSelector;
            const productQuantitySelector = app.settings.selectors.productQuantitySelector;
            const productAddToCartTextElement = app.settings.selectors.productAddToCartTextElement;
            const paymentButton = app.settings.selectors.paymentButton;     
            
            var n = app.settings.selectors.productAddToCartBtn.find((function(t) { return form.find(t).length }));
            app.renderProductForm(product, form, productVariantActivator, productVariantSelector, productQuantitySelector, n, productAddToCartTextElement, paymentButton)
            app.renderBisForm(product, form, productVariantActivator, productVariantSelector)
        },
        appSetInterval: function(t, e, r) {
            t();
            var n = 0
                , o = window.setInterval((function() {
                t(),
                ++n === r && window.clearInterval(o)
            }), e)
        },
        showPreorderButton: function(){
            const app = this;
            document.addEventListener('globo.preorder.show.preorder', e => {
                const { form, profile } = e.detail;

                window.Globo.Preorder.appSetInterval(() => {
                    if(form.hasClass('singleProductPreOrderForm')){
                        let stickyBtn = $('.zrx-sticky-atc-main-button')
        
                        if(stickyBtn.length){
                            stickyBtn.addClass('gPreorderBtn')
                            stickyBtn.html(profile.message.preorderText);
                            stickyBtn.removeClass('gSoldout')

                            if(profile.discountPayment.partialPayment.enable && !profile.discountPayment.fullPayment.enable){
                                app.handleAddPreorder(form, profile, stickyBtn)
                            }
                        }
                        // app.showDiscountPercentage(form, profile)
                    }
                    // app.handleValidateLimitStock(form, profile)
                    
                    document.querySelectorAll('[name="_preorder_partial_payment"]').length &&
                        document.querySelectorAll('[name="_preorder_partial_payment"]').forEach(el => {
                        el.addEventListener('change', function(){
                            console.log('changee', el)
                            if(el.value == 'full'){
                            form.removeClass("gPreorderPartialPaymentForm")
                            if(profile.discountPayment.enable && parseFloat(profile.discountPayment.discountValue) > 0){
                                form.addClass("gPreorderDiscountForm")
                            }
                            } else if(el.value == 'part'){
                            form.addClass("gPreorderPartialPaymentForm")
                            form.removeClass("gPreorderDiscountForm")
                            }
                        })
                        })
                }, 800, 3)
            })
        },
        showDiscountPercentage: function(form, profile){
            const app = this;
            const { fullPayment, partialPayment } = profile.discountPayment;
            const fullPaymentDicount = parseInt(fullPayment.discountValue) >= 10 ? fullPayment.discountValue : fullPayment.discountValue.toString().replace('0', '');
            const partialPaymentDicount = parseInt(partialPayment.discountValue) >= 10 ? partialPayment.discountValue : partialPayment.discountValue.toString().replace('0', '');
            const partialPaymentValue = parseInt(partialPayment.value) >= 10 ? partialPayment.value : partialPayment.value.toString().replace('0', '');
            if(fullPayment.enable && partialPayment.enable){
            form.find('.gPreorderPrice').addClass('gPreorderHidden');
            
            if(fullPayment.discountType == 'percentage' && parseInt(fullPayment.discountValue) > 0){
                form.find('.gFullPaymentDiscountPrice').length == 0 &&
                form.find('.gPreorderPartialPaymentChoices li').first().find('.gPreorderPartialPaymentLabel').append(`<span class="gFullPaymentDiscountPrice">${form.find('.gPreorderPriceHtml').text()}`)
                form.find('.gFullPaymentDiscount').length == 0 &&
                form.find('.gPreorderPartialPaymentChoices li').first().find('.gPreorderPartialPaymentLabel').append(`<span class="gFullPaymentDiscount">${fullPaymentDicount}% Discount</span>`)
            }

            form.find('.gPartialPaymentValue').length == 0 &&
                form.find('.gPreorderPartialPaymentChoices li').last().find('.gPreorderPartialPaymentLabel').append(`<span class="gPartialPaymentValue">${partialPaymentValue}% of Full Price</span>`)

            // form.find('.gPreorderPartialPaymentInput').on('change', function(e){
                
                // if(e.target.value == 'full'){
                
                // form.find('.gFullPaymentDiscountPrice').remove()
                // form.find('.gFullPaymentDiscount').remove()
                // if(fullPayment.discountType == 'percentage' && parseInt(fullPayment.discountValue) > 0){
                //   if(form.find('.gFullPaymentDiscount').length == 0)
                //     form.find('.gPreorderPartialPaymentChoices li').first().find('.gPreorderPartialPaymentLabel').append(`<span class="gFullPaymentDiscountPrice">${form.find('.gPreorderPriceHtml').text()}`)
                //   else
                //     form.find('.gFullPaymentDiscountPrice').text(`${form.find('.gPreorderPriceHtml').text()}`);

                //   if(form.find('.gFullPaymentDiscount').length == 0)
                //     form.find('.gPreorderPartialPaymentChoices li').first().find('.gPreorderPartialPaymentLabel').append(`<span class="gFullPaymentDiscount">${fullPaymentDicount}% Discount</span>`)
                //   else
                //     form.find('.gFullPaymentDiscount').text(`(${fullPaymentDicount}% Discount)`);
                // }else{
                //   form.find('.gFullPaymentDiscountPrice').remove()
                //   form.find('.gFullPaymentDiscount').remove()
                // }
                
                // }else if(e.target.value == 'part'){
                
                // form.find('.gFullPaymentDiscountPrice').remove()
                // form.find('.gFullPaymentDiscount').remove()
                // if(partialPayment.discountType == 'percentage' && parseInt(partialPayment.discountValue) > 0){
                //   if(form.find('.gFullPaymentDiscountPrice').length == 0)
                //     form.find('.gPreorderPartialPaymentChoices li').first().find('.gPreorderPartialPaymentLabel').append(`<span class="gFullPaymentDiscountPrice">${form.find('.gPreorderPriceHtml').text()}`)
                //   else
                //     form.find('.gFullPaymentDiscountPrice').text(`${form.find('.gPreorderPriceHtml').text()}`);

                //   if(form.find('.gFullPaymentDiscount').length == 0)
                //     form.find('.gPreorderPartialPaymentChoices li').first().find('.gPreorderPartialPaymentLabel').append(`<span class="gFullPaymentDiscount">${partialPaymentDicount}% Discount</span>`)
                //   else
                //     form.find('.gFullPaymentDiscount').text(`(${partialPaymentDicount}% Discount)`);
                // }else{
                //   form.find('.gFullPaymentDiscountPrice').remove()
                //   if(form.find('.gFullPaymentDiscountPrice').length == 0)
                //     form.find('.gPreorderPartialPaymentChoices li').first().find('.gPreorderPartialPaymentLabel').append(`<span class="gFullPaymentDiscountPrice">${form.find('.price-list').html()}`)
                //   else
                //     form.find('.gFullPaymentDiscountPrice').html(`${form.find('.price-list').html()}`);
                //   form.find('.gFullPaymentDiscount').remove()
                // }
                
            //   }
            // })
            
            }else if(!fullPayment.enable && partialPayment.enable){
            form.find('.gPartialPaymentValue').length == 0 &&
                form.find('.gPreorderPartialPaymentChoices li').last().find('.gPreorderPartialPaymentLabel').append(`<span class="gPartialPaymentValue">${partialPaymentValue}% of Full Price</span>`)
            
            }else if(fullPayment.enable && !partialPayment.enable){
            
            if(fullPayment.discountType == 'percentage' && parseInt(fullPayment.discountValue) > 0 && form.find('.gPreorderPriceDiscount').length == 0){
                if(form.find('.gFullPaymentDiscount').length == 0)
                form.find('.gPreorderPartialPaymentChoices li').first().find('.gPreorderPartialPaymentLabel').append(`<span class="gFullPaymentDiscountPrice">${form.find('.gPreorderPriceHtml').text()}`)
                else
                form.find('.gFullPaymentDiscountPrice').text(`${form.find('.gPreorderPriceHtml').text()}`);

                if(form.find('.gFullPaymentDiscount').length == 0)
                form.find('.gPreorderPartialPaymentChoices li').first().find('.gPreorderPartialPaymentLabel').append(`<span class="gFullPaymentDiscount">${fullPaymentDicount}% Discount</span>`)
                else
                form.find('.gFullPaymentDiscount').text(`(${fullPaymentDicount}% Discount)`);
            }

            
            }
        },
        showDiscountFullPayment: function(form, profile){
            const app = this;
            const { fullPayment, partialPayment } = profile.discountPayment;
            const price = profile.variant.price / 100;

            if(fullPayment.enable && fullPayment.discountValue != '0'){
                let paymentElement = form.find('.gPreorderPartialPaymentChoices li').first()

                if(paymentElement.length){
                    let discountPrice = price;

                    if(fullPayment.discountType == 'percentage'){
                        discountPrice = price * (parseInt(fullPayment.discountValue) / 100);
                        let newPrice = Globo.moneyFormat.replace(`{` + `{amount}` + '}', discountPrice)

                        if(paymentElement.find('.gPreorderPartialPaymentLabel span').length == 0){
                            paymentElement.find('.gPreorderPartialPaymentLabel').append(`<span>${newPrice}</span>`)
                        }

                        
                        app.handlePaymentOptionChange(form, paymentElement)
                    }
                }
            }
        },
        handlePaymentOptionChange: function(form, paymentElement){
            const app = this;

            let paymentElements = form.find('.gPreorderPartialPaymentChoices li')

            if(form.find('.gPreorderPrice').find('.gFullPaymentLabel').length == 0 && paymentElement.find('input:checked').length){
                form.find('.gPreorderPrice').append(`<span class="gFullPaymentLabel">against full advance payment</span>`)
            }else{
                form.find('.gPreorderPrice span.gFullPaymentLabel').remove()
            }
        },
        handleAddPreorder: function(form, profile, stickyBtn){
                stickyBtn.click(async e => {
                    e.preventDefault()
                    e.stopPropagation()

                    var data = {
                    properties: {
                        _is_preorder: form.find(".gPreorderProperty").val(),
                        _preorder_locale: form.find('.gPreorderLocale').val()
                    },
                    preorder_id: form.find(".gPreorderId").val(),
                    product_id: form.find(".gPreorderProductId").val(),
                    id: profile.variant.id.toString(),
                    quantity: form.find('.quantity-selector__value').val(),
                    _preorder_partial_payment: form.find("." + window.Globo.Preorder.settings.classes.partialPayment + "Input:checked").val(),
                    shop: window.Globo.Preorder.settings.shop,
                    customer: window.Globo.Preorder.settings.customer ? Globo.Preorder.settings.customer : null,
                    locale: window.Globo.Preorder.settings.shop
                }

                    let invoice = await window.Globo.Preorder.createDraftOrder(data);               
                    window.Globo.Preorder.createDraftOrderCallBack(invoice);
            })
        },
        handleValidateLimitStock: function(form, profile){
            const safeForm = form instanceof HTMLElement ? form : form?.[0];
            if (!safeForm) return;
            if (safeForm.classList.contains('singleProductPreOrderForm')) {
                const preorderLimit = safeForm.querySelector('[preorder-limit]');
                if (preorderLimit) {
                    const quantityActions = safeForm.querySelectorAll(
                        '.quantity-selector__value, .quantity-selector__button'
                    );
                    if (quantityActions.length) {
                        const handleCheck = () => {
                            const limit = parseInt(preorderLimit.getAttribute('preorder-limit'));
                            const value = parseInt(preorderLimit.value);
                            if (value > limit) {
                                alert(`There are still ${limit} pre-order items that can be added to the cart.`);
                                preorderLimit.value = limit;
                            }
                        };
                        quantityActions.forEach(el => {
                            el.addEventListener('change', handleCheck);
                            el.addEventListener('blur', handleCheck);
                        });
                    }
                }
            }
        },
        showAddToCartButton: function(){
           document.addEventListener('globo.preorder.show.addtocart', (e) => {
                const { form } = e.detail;
                window.Globo.Preorder.appSetInterval(() => {
                    const safeForm = form instanceof HTMLElement ? form : form?.[0];
                    if (!safeForm) return;
                    if (safeForm.classList.contains('singleProductPreOrderForm')) {
                        const stickyBtn = document.querySelector('.zrx-sticky-atc-main-button.gPreorderBtn');
                        if (stickyBtn) {
                            stickyBtn.classList.remove('gPreorderBtn');
                            stickyBtn.innerHTML = "Add To Cart";
                            stickyBtn.classList.remove('gSoldout');
                        }
                    }
                }, 600, 2);
            });
        },
        debounce: function(func, timeout = 300){
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }
    }
    preorderCustom.render()
</script>
<style>
    .gBackInStockBtn {
        animation: gpo-glowing 1000ms infinite;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }
    .gBackInStockBtn svg {
        animation: gpo-shaking 0.5s infinite;
    }
    #Globo-Back-In-Stock{
        margin: 0px !important;
        padding: 5px;
    }

    @keyframes gpo-glowing {   
        0% {     background-color: #000000;     box-shadow: 0 0 5px #000000;   }   
        50% {     background-color: #1f2427;     box-shadow: 0 0 20px #1f2427;   }   
        100% {     background-color: #4cb5f1;     box-shadow: 0 0 5px #4cb5f1;   } 
    }

    @keyframes gpo-shaking {   
        0% { transform: rotate(0deg); }   
        25% { transform: rotate(5deg); }   
        50% { transform: rotate(0eg); }   
        75% { transform: rotate(-5deg); }   
        100% { transform: rotate(0deg); } 
    }
    .gBisShowing .magic-buy-btn,
    .gBisShowing .magic-buy-btn__parent,
    .gPositionBis:empty{
        display: none !important;
    }
    .gSoldout{
        background: #FFFFFF !important;
        color: #606060 !important;
        border: 1px solid #3A3A3A !important;
        opacity: .7 !important;
        pointer-events: none !important;
    }
    .gridProductPreOrderForm .gBackInStockBtn{
        font-size: 14px !important; 
    }
    
    .gridProductPreOrderForm .gPreorderPartialPaymentWrapper .gPreorderPartialPaymentChoices{
        padding: 0px !important;
    }
    .gridProductPreOrderForm .gPreorderPartialPaymentWrapper{
        padding: 0px 0 10px !important;
    }
    
    @media(max-width: 640px){
        #Globo-Back-In-Stock{
            margin: 0px !important;
            padding: 0px !important;
        }
        .gridProductPreOrderForm .gPreorderPartialPaymentWrapper .gPreorderPartialPaymentChoices .gPreorderPartialPaymentControl{
            margin-right: .4rem !important;
            width: 10px !important;
            height: 10px !important;
        }
        .gridProductPreOrderForm .gPreorderPartialPaymentWrapper .gPreorderPartialPaymentChoices li label,
        .gridProductPreOrderForm .gPreorderPartialPaymentLabel>span{
            font-size: 12px !important;
        }
        .gridProductPreOrderForm .gBackInStockBtn {
            font-size: 11px !important;
        }
    }
    .gPreorderPartialPaymentLabel>span {
        margin-left: 5px;
    }
    .gFullPaymentDiscountPrice span.price {
        font-size: 14px !important;
        color: #555555 !important;
    }
    #Globo-Back-In-Stock {
        padding: 5px 0 !important;
    }
    button.collectionPreorderAddToCartBtn {
        border-radius: 30px !important;
        width: 100%;
    }
</style>