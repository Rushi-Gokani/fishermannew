<script>
/**
 * Globo Pre-order Custom Configuration
 * Customized for product-page-modern.liquid template
 */
const preorderCustom = {
    initialized: false,
    render: function(){
        this.initSelectors();
        this.handleEvents();
        this.initialized = true;
    },
    initSelectors: function(){
        window.GloboPreorderParams = window.GloboPreorderParams || {};
        window.GloboPreorderParams.selectors = window.GloboPreorderParams.selectors || {};

        // Position hooks for pre-order/BIS form injection (primary placeholder + fallback on buttons row)
        window.GloboPreorderParams.selectors.productPositionBis = '.gPositionBis, .modern-product-actions';

        // Variant activators - elements that trigger variant changes
        // Include variant-picker custom element
        if(window.GloboPreorderParams.selectors.productVariantActivator) {
            window.GloboPreorderParams.selectors.productVariantActivator += ", .modern-variant-swatch, .modern-variant-options input[type='radio'], input[name^='option'], variant-picker";
        } else {
            window.GloboPreorderParams.selectors.productVariantActivator = ".modern-variant-swatch, .modern-variant-options input[type='radio'], input[name^='option'], .product-form__single-selector, variant-picker";
        }

        // Product form selectors - multiple patterns to ensure detection
        window.GloboPreorderParams.selectors.productForm = "form.product-form, form[data-product-form], .modern-product-form__form, .singleProductPreOrderForm";

        // Add to cart button selectors - must match your button
        window.GloboPreorderParams.selectors.productAddToCartBtn = window.GloboPreorderParams.selectors.productAddToCartBtn || [];
        if(Array.isArray(window.GloboPreorderParams.selectors.productAddToCartBtn)) {
            if(!window.GloboPreorderParams.selectors.productAddToCartBtn.includes('[data-action="add-to-cart"]')) {
                window.GloboPreorderParams.selectors.productAddToCartBtn.push('[data-action="add-to-cart"]');
            }
            if(!window.GloboPreorderParams.selectors.productAddToCartBtn.includes('.product-form__add-button')) {
                window.GloboPreorderParams.selectors.productAddToCartBtn.push('.product-form__add-button');
            }
            if(!window.GloboPreorderParams.selectors.productAddToCartBtn.includes('.modern-add-to-cart')) {
                window.GloboPreorderParams.selectors.productAddToCartBtn.push('.modern-add-to-cart');
            }
        }

        // Payment container
        window.GloboPreorderParams.selectors.productPaymentContainer = ".product-form__payment-container, .modern-atc-wrapper";

        // Quantity selector
        window.GloboPreorderParams.selectors.productQuantitySelector = ".quantity-selector__value, .modern-quantity-input, input[name='quantity']";

        // Collection/Quick view selectors
        window.GloboPreorderParams.selectors.collectionProductForms = ".product-item form, .product-card form";
        window.GloboPreorderParams.selectors.quickViewActivator = ".quick-add-btn, .product-item__action-button";
        window.GloboPreorderParams.selectors.quickViewProductForm = ".modal[aria-hidden=false] form, .quick-add-modal form";

        // Collection filter selectors
        if(window.GloboPreorderParams.selectors.collectionFilterSelector) {
            window.GloboPreorderParams.selectors.collectionFilterSelector += ", .collection__filter-checkbox label, .pagination__nav-item";
        }

        window.GloboPreorderParams.selectors.collectionAddToCartBtn = ".product-item__action-button, .quick-add-btn";

        console.log('[Globo Custom] Selectors initialized:', window.GloboPreorderParams.selectors);
    },
    handleEvents: function(){
        const app = this;

        // Handle variant changes - improved with more robust timing
        document.addEventListener('globo.preorder.variant.changed', () => {
            console.log('[Globo Custom] Variant changed event received');
            app.appSetInterval(() => {
                let gSingleProductForm = document.querySelector('form.singleProductPreOrderForm');
                if(gSingleProductForm && window?.GloboPreorderParams?.page == 'product'){
                    if(window?.Globo?.Preorder) {
                        console.log('[Globo Custom] Re-rendering product form');
                        window.Globo.Preorder.renderProductForm &&
                            window.Globo.Preorder.renderProductForm(window.GloboPreorderParams.product);
                    } else {
                        console.warn('[Globo Custom] Globo.Preorder not available');
                    }
                }
            }, 600, 3);
        });

        // Handle Back in Stock button showing
        document.addEventListener('globo.preorder.show.bis', function (e) {
            const {form, type} = e.detail;
            if(type === '#Globo-Back-In-Stock'){
                // Hide the regular add to cart button when BIS is shown
                const addToCartBtn = form.querySelector ? form.querySelector('[data-add-to-cart]') : form.find('[data-add-to-cart]');
                if(addToCartBtn) addToCartBtn.style.display = 'none';
            }
        });

        // Handle Add to Cart button showing (revert from pre-order state)
        document.addEventListener('globo.preorder.show.addtocart', function (e) {
            const {form, type} = e.detail;
            const addToCartBtn = form.querySelector ? form.querySelector('[data-add-to-cart]') : form.find('[data-add-to-cart]');
            if(addToCartBtn) addToCartBtn.style.display = '';
        });

        // Initialize on page load - with improved timing
        function initPreorderApp() {
            console.log('[Globo Custom] Initializing preorder app');
            app.handleVariantChange();
            if(window?.Globo?.Preorder) {
                window.Globo.Preorder.initPreorder();
                console.log('[Globo Custom] Globo.Preorder.initPreorder() called successfully');
            } else {
                console.warn('[Globo Custom] Globo.Preorder not available yet, will retry...');
                // Retry after a delay
                setTimeout(initPreorderApp, 1000);
            }
        }

        // Start initialization on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPreorderApp);
        } else {
            initPreorderApp();
        }

        // Also try on window load as backup
        window.addEventListener('load', () => {
            console.log('[Globo Custom] Window loaded, initializing preorder');
            initPreorderApp();
        });

        // Re-initialize on scroll for lazy-loaded content
        window.onscroll = app.debounce(() => {
            if(window?.GloboPreorderParams?.page == 'index' || window?.GloboPreorderParams?.page == 'collection'){
                window?.Globo?.Preorder && window.Globo.Preorder.initPreorder();
            }
        }, 1500);
    },

    // Use event delegation for variant changes to handle dynamically added elements
    handleVariantChange: function(){
        const app = this;

        // Remove old listener if exists to avoid duplicates
        if (app.variantChangeHandler) {
            document.removeEventListener('change', app.variantChangeHandler);
            document.removeEventListener('click', app.variantChangeHandler);
        }

        // Create a unified handler that uses event delegation
        app.variantChangeHandler = function(e) {
            const target = e.target;

            // Check if the clicked/changed element is a variant selector
            const isVariantSelector = target.matches('.modern-variant-swatch, .modern-variant-options input[type="radio"], input[name^="option"]') ||
                                     target.closest('.modern-variant-swatch') ||
                                     target.closest('variant-picker');

            if (isVariantSelector) {
                console.log('[Globo Custom] Variant selector clicked/changed', target);
                app.appSetInterval(() => {
                    if(window?.Globo?.Preorder){
                        console.log('[Globo Custom] Calling Globo.Preorder.initPreorder()');
                        window.Globo.Preorder.initPreorder();
                    } else {
                        console.warn('[Globo Custom] Globo.Preorder not available');
                    }
                }, 400, 3);
            }
        };

        // Use event delegation on document to catch all events including dynamically added elements
        document.addEventListener('change', app.variantChangeHandler);
        document.addEventListener('click', app.variantChangeHandler);
    },
    appSetInterval: function(callback, interval, times) {
        callback();
        var count = 0;
        var intervalId = window.setInterval(function() {
            callback();
            if(++count === times) window.clearInterval(intervalId);
        }, interval);
    },
    debounce: function(func, timeout = 300){
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    }
};

// Initialize when DOM is ready
if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => preorderCustom.render());
} else {
    preorderCustom.render();
}

// Wait for Globo Preorder app to load and then re-initialize
// This handles the case where the app script loads after this custom script
function waitForGloboAndInit() {
    if (window.Globo && window.Globo.Preorder && !preorderCustom.initialized) {
        console.log('[Globo Custom] Globo.Preorder detected, initializing...');
        preorderCustom.render();
    } else if (window.Globo && window.Globo.Preorder && preorderCustom.initialized) {
        // Already initialized, just call initPreorder
        console.log('[Globo Custom] Globo.Preorder detected, calling initPreorder...');
        window.Globo.Preorder.initPreorder();
    }
}

// Poll for Globo to be available (in case it loads async)
let globoCheckCount = 0;
const globoCheckInterval = setInterval(() => {
    globoCheckCount++;
    if (window.Globo && window.Globo.Preorder) {
        clearInterval(globoCheckInterval);
        waitForGloboAndInit();
        console.log('[Globo Custom] Globo.Preorder is now available');
    } else if (globoCheckCount > 30) {
        // Stop checking after 30 attempts (15 seconds)
        clearInterval(globoCheckInterval);
        console.warn('[Globo Custom] Globo.Preorder not detected after 15 seconds');
    }
}, 500);

// Observe for DOM changes in the product form to re-attach variant listeners
// This is needed because the variant picker uses morphdom which replaces elements
const observeProductForm = () => {
    const productForm = document.querySelector('.modern-product-form__form, .singleProductPreOrderForm');
    if (productForm) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' || mutation.type === 'characterData') {
                    // Re-initialize Globo preorder when variant picker changes
                    if (window.Globo && window.Globo.Preorder) {
                        // Debounce to avoid excessive calls
                        clearTimeout(preorderCustom.mutationTimer);
                        preorderCustom.mutationTimer = setTimeout(() => {
                            console.log('[Globo Custom] DOM changed, re-initializing preorder');
                            window.Globo.Preorder.initPreorder();
                        }, 300);
                    }
                }
            });
        });

        // Start observing the product form
        observer.observe(productForm, {
            childList: true,
            subtree: true,
            characterData: true
        });
        console.log('[Globo Custom] MutationObserver attached to product form');
    }
};

// Attach the observer after a short delay to ensure DOM is ready
setTimeout(observeProductForm, 1000);
</script>

<style>
/* ========================================
   Globo Pre-order Custom Styles
   For Modern Product Page Integration
   ======================================== */

/* ========== Pre-order Button ========== */
.gPreorderBtn,
.modern-product-form .gPreorderBtn,
.product-form .gPreorderBtn,
form.product-form button.gPreorderBtn {
    background: #D32F2F !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 0 24px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    width: 100% !important;
    min-height: 52px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 4px 12px rgb(211 47 47 / 0.3) !important;
}

.gPreorderBtn:hover:not(:disabled) {
    background: #B71C1C !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 6px 16px rgb(211 47 47 / 0.4) !important;
}

/* ========== Back in Stock Button ========== */
.gBackInStockBtn,
#Globo-Back-In-Stock .gBackInStockBtn {
    animation: gpo-glowing 1500ms infinite;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0.5rem;
    background: #40C4FF !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 0 24px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    width: 100% !important;
    min-height: 52px !important;
    box-shadow: 0 4px 12px rgb(64 196 255 / 0.3) !important;
}

.gBackInStockBtn svg {
    animation: gpo-shaking 0.5s infinite;
}

@keyframes gpo-glowing {
    0% { background-color: #40C4FF; box-shadow: 0 0 5px #40C4FF; }
    50% { background-color: #0288D1; box-shadow: 0 0 15px #0288D1; }
    100% { background-color: #40C4FF; box-shadow: 0 0 5px #40C4FF; }
}

@keyframes gpo-shaking {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(5deg); }
    50% { transform: rotate(0deg); }
    75% { transform: rotate(-5deg); }
    100% { transform: rotate(0deg); }
}

/* ========== Layout & Container Fixes ========== */
.modern-product-actions .gPositionBis {
    width: 100%;
    margin-top: 12px;
}

/* Preorder wrapper - full width */
.globo-preorder-app .gpo-form-wrapper,
.gpo-form-wrapper,
.gPreorderWrapper {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    box-sizing: border-box !important;
}

/* Preorder heading */
.gpo-text-heading,
.globo-preorder-app .gpo-heading,
.gPreorderHeading {
    font-size: 15px !important;
    font-weight: 600 !important;
    color: #e53935 !important;
    margin: 0 0 12px 0 !important;
    text-align: left !important;
}

/* Price row - align with quantity */
.globo-preorder-app .gpo-price-row,
.gpo-price-row {
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    width: 100% !important;
}

/* Price label */
.gpo-price-label,
.globo-preorder-app .gpo-price-label {
    font-size: 13px !important;
    font-weight: 500 !important;
    color: #64748b !important;
    margin: 0 !important;
}

/* Price amount */
.gpo-price,
.globo-preorder-app .gpo-price {
    font-size: 24px !important;
    font-weight: 700 !important;
    color: #101828 !important;
    margin: 0 !important;
}

/* ========== Partial Payment Section ========== */
.globo-preorder-app .gpo-partial-payment-wrapper,
.gpo-partial-payment-wrapper,
.modern-product-form .gPreorderPartialPaymentWrapper {
    width: 100% !important;
    margin: 12px 0 0 0 !important;
    padding: 14px 16px !important;
    border: 1px solid #e2e8f0 !important;
    border-radius: 10px !important;
    background: #f8fafc !important;
    box-sizing: border-box !important;
}

.globo-preorder-app .gpo-partial-payment-choices,
.gpo-partial-payment-choices,
.modern-product-form .gPreorderPartialPaymentChoices {
    width: 100% !important;
    padding: 0 !important;
    margin: 8px 0 0 0 !important;
    list-style: none !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
    box-sizing: border-box !important;
}

.globo-preorder-app .gpo-partial-payment-choices li,
.gpo-partial-payment-choices li,
.modern-product-form .gPreorderPartialPaymentChoices li {
    width: 100% !important;
    margin: 0 !important;
    padding: 12px 14px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    gap: 12px !important;
    border: 1px solid #dbe1ea !important;
    border-radius: 10px !important;
    background: #fff !important;
    box-sizing: border-box !important;
}

/* Payment label */
.globo-preorder-app .gpo-payment-label,
.gpo-payment-label,
.gPreorderPartialPaymentLabel {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: #111827 !important;
}

.globo-preorder-app .gpo-payment-label span,
.globo-preorder-app .gpo-payment-label small,
.gpo-payment-label span,
.gpo-payment-label small {
    font-size: 12px !important;
    font-weight: 400 !important;
    color: #64748b !important;
}

/* Radio input */
.globo-preorder-app .gpo-radio input[type='radio'],
.gpo-radio input[type='radio'] {
    accent-color: #D32F2F !important;
    width: 18px !important;
    height: 18px !important;
}

/* ========== Back in Stock Form ========== */
#Globo-Back-In-Stock {
    margin: 12px 0 0 0 !important;
    padding: 0 !important;
    width: 100% !important;
}

#Globo-Back-In-Stock form {
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
}

#Globo-Back-In-Stock input[type="email"],
#Globo-Back-In-Stock input[type="text"] {
    width: 100% !important;
    padding: 14px 16px !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 10px !important;
    font-size: 15px !important;
    box-sizing: border-box !important;
}

/* ========== Message Styling ========== */
.globo-preorder-app .gpo-message,
.gpo-message,
.gPreorderMessage {
    font-size: 13px !important;
    color: #64748b !important;
    margin: 8px 0 0 0 !important;
    line-height: 1.5 !important;
}

/* ========== Hide empty elements ========== */
.gPositionBis:empty {
    display: none !important;
}

/* ========== Mobile Responsive ========== */
@media (max-width: 749px) {
    .gPreorderBtn,
    .gBackInStockBtn {
        padding: 0 20px !important;
        font-size: 15px !important;
        min-height: 50px !important;
    }
}
</style>
