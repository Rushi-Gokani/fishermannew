{% comment %}
  Product Card Item Snippet
  Renders a single product card matching the reference design
{% endcomment %}

{%- liquid
  assign show_badge = show_badge | default: false
  assign badge_text = badge_text | default: 'Best Seller'

  assign on_sale = false
  if product.compare_at_price > product.price
    assign on_sale = true
  endif

  assign sold_out = false
  unless product.available
    assign sold_out = true
  endunless
-%}

<div class="product-card-{{ section_id }}">
  <!-- Top Section: Badge and Heart -->
  <div class="product-card-top-{{ section_id }}">
    {% if show_badge %}
      <span class="product-card-badge-{{ section_id }}">{{ badge_text }}</span>
    {% endif %}
    <button
      class="product-card-wishlist-{{ section_id }}"
      aria-label="Add to wishlist"
      data-product-handle="{{ product.handle }}"
    >
      <svg viewBox="0 0 24 24" fill="{{ section_settings.wishlist_fill }}" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
      </svg>
    </button>
  </div>

  <!-- Image Section -->
  <div class="product-card-image-wrapper-{{ section_id }}">
    <div class="product-card-slider-wrapper-{{ section_id }}">
      <div class="product-card-slider-container-{{ section_id }}" id="slider-{{ section_id }}-{{ product.id }}">
        {% if product.images.size > 0 %}
          {% for image in product.images limit: 3 %}
            <img
              src="{{ image | image_url: width: 400 }}"
              alt="{{ image.alt | escape }}"
              loading="lazy"
              width="400"
              height="400"
              class="product-card-image-{{ section_id }}"
              draggable="false"
            >
          {% endfor %}
        {% else %}
          {{ 'product-' | append: product.id | placeholder_svg_tag: 'product-card-image-' | append: section_id }}
        {% endif %}
      </div>
    </div>

    <!-- Arrows -->
    {% if product.images.size > 1 %}
      <button class="product-card-arrow-{{ section_id }} product-card-arrow-prev-{{ section_id }}" aria-label="Previous image">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
        </svg>
      </button>
      <button class="product-card-arrow-{{ section_id }} product-card-arrow-next-{{ section_id }}" aria-label="Next image">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
        </svg>
      </button>
    {% endif %}

    <!-- Pagination Dots -->
    {% if product.images.size > 1 %}
      <div class="product-card-dots-{{ section_id }}" id="dots-{{ section_id }}-{{ product.id }}">
        {% for image in product.images limit: 3 %}
          <span class="product-card-dot-{{ section_id }}{% if forloop.first %} active{% endif %}" data-image-index="{{ forloop.index | minus: 1 }}"></span>
        {% endfor %}
      </div>
    {% else %}
      <div class="product-card-dots-{{ section_id }}">
        <span class="product-card-dot-{{ section_id }} active"></span>
        <span class="product-card-dot-{{ section_id }}"></span>
        <span class="product-card-dot-{{ section_id }}"></span>
      </div>
    {% endif %}
  </div>

  <!-- Bottom Section: Brand, Title, Price, Button -->
  <div class="product-card-content-{{ section_id }}">
    {% if product.vendor %}
      <p class="product-card-brand-{{ section_id }}">{{ product.vendor }}</p>
    {% endif %}

    <h3 class="product-card-title-{{ section_id }}">
      <a href="{{ product.url }}">{{ product.title }}</a>
    </h3>

    <p class="product-card-price-{{ section_id }}">
      {% if on_sale %}
        <span class="sale-price">{{ product.price | money }}</span>
        <span class="compare-price">{{ product.compare_at_price | money }}</span>
      {% else %}
        {{ product.price | money }}
      {% endif %}
    </p>

    <form method="post" action="/cart/add" class="product-card-form-{{ section_id }}" data-product-id="{{ product.id }}">
      <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" />
      <button
        type="submit"
        class="product-card-buy-btn-{{ section_id }} {% if sold_out %}disabled{% endif %}"
        {% if sold_out %}disabled{% endif %}
      >
        {% if sold_out %}
          Sold Out
        {% else %}
          Buy Now
        {% endif %}
      </button>
    </form>
  </div>
</div>

{% comment %}
  Image gallery JavaScript with touch slider support
{% endcomment %}
<script>
  (function() {
    const cardId = '{{ section_id }}-{{ product.id }}';
    const slider = document.getElementById('slider-' + cardId);
    const dotsContainer = document.getElementById('dots-' + cardId);
    const dots = dotsContainer?.querySelectorAll('.product-card-dot-{{ section_id }}');
    const imageWrapper = dotsContainer?.closest('.product-card-image-wrapper-{{ section_id }}');
    const prevArrow = imageWrapper?.querySelector('.product-card-arrow-prev-{{ section_id }}');
    const nextArrow = imageWrapper?.querySelector('.product-card-arrow-next-{{ section_id }}');
    const productUrl = '{{ product.url }}';

    if (!slider || !dots || dots.length <= 1) return;

    let currentIndex = 0;
    let isDragging = false;
    let startPos = 0;
    let currentTranslate = 0;
    let prevTranslate = 0;
    let animationID;
    let startTime = 0;
    const totalSlides = dots.length;

    function updateDots(index) {
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });
    }

    function updateArrows(index) {
      if (prevArrow) prevArrow.disabled = index === 0;
      if (nextArrow) nextArrow.disabled = index === totalSlides - 1;
    }

    function setSliderPosition() {
      slider.style.transform = `translateX(${currentTranslate}%)`;
    }

    function slideTo(index) {
      if (index < 0) index = 0;
      if (index >= totalSlides) index = totalSlides - 1;

      currentIndex = index;
      currentTranslate = index * -100;
      prevTranslate = currentTranslate;
      slider.style.transition = 'transform 0.3s ease-out';
      setSliderPosition();
      updateDots(index);
      updateArrows(index);
    }

    // Touch events
    slider.addEventListener('touchstart', touchStart);
    slider.addEventListener('touchmove', touchMove);
    slider.addEventListener('touchend', touchEnd);

    // Mouse events
    slider.addEventListener('mousedown', touchStart);
    slider.addEventListener('mouseup', touchEnd);
    slider.addEventListener('mouseleave', () => {
      if (isDragging) {
        isDragging = false;
        slider.style.transition = 'transform 0.3s ease-out';
        slideTo(currentIndex);
      }
    });
    slider.addEventListener('mousemove', touchMove);

    function touchStart(event) {
      isDragging = true;
      startTime = Date.now();
      startPos = getPositionX(event);
      slider.style.transition = 'none'; // distinct transition for drag
      animationID = requestAnimationFrame(animation);
    }

    function touchMove(event) {
      if (isDragging) {
        const currentPosition = getPositionX(event);
        const diff = currentPosition - startPos;
        // Calculate percentage movement based on slider width
        const movePercent = (diff / slider.offsetWidth) * 100;
        currentTranslate = prevTranslate + movePercent;
      }
    }

    function touchEnd() {
      isDragging = false;
      cancelAnimationFrame(animationID);

      const movedBy = currentTranslate - prevTranslate;
      const timeDiff = Date.now() - startTime;
      
      // If moved significantly or quick swipe
      if (movedBy < -20 || (movedBy < -5 && timeDiff < 300)) {
        if (currentIndex < totalSlides - 1) currentIndex += 1;
      } else if (movedBy > 20 || (movedBy > 5 && timeDiff < 300)) {
        if (currentIndex > 0) currentIndex -= 1;
      } else if (Math.abs(movedBy) < 1) {
         // Clicked/Tapped without much movement - navigate to product
         window.location.href = productUrl;
         return;
      }

      slideTo(currentIndex);
    }

    function getPositionX(event) {
      return event.type.includes('mouse') ? event.clientX : event.touches[0].clientX;
    }

    function animation() {
      setSliderPosition();
      if (isDragging) requestAnimationFrame(animation);
    }

    // Initialize events for touch and mouse
    // handled by addEventListener above

    // Dot clicks
    dots.forEach((dot, index) => {
      dot.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation(); // prevent card click
        slideTo(index);
      });
    });

    // Arrow clicks
    if (prevArrow) {
      prevArrow.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        slideTo(currentIndex - 1);
      });
    }

    if (nextArrow) {
      nextArrow.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        slideTo(currentIndex + 1);
      });
    }

    // Initial arrow state
    updateArrows(0);

    // Auto-advance
    // let autoSlideInterval =  setInterval(() => {
    //   if (!isDragging) {
    //      let nextIndex = (currentIndex + 1) % totalSlides;
    //      slideTo(nextIndex);
    //   }
    // }, 4000); 
    // Commented out auto-slide to prevent interference with user interaction on mobile, 
    // or we can keep it but clear on interaction.
  })();
</script>
