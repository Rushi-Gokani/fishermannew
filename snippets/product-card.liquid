{%- comment -%}
  Product Card Snippet - New Design
  Features: Best Seller badge, heart icon, swipeable image dots, Buy Now button (#40C4FF)
  Fixed height cards with title truncation

  @param {object} product - The product object
  @param {object} children - The children of the product card
  @param {object} [block] - The block object
{%- endcomment -%}

{% assign block_settings = block.settings %}
{% assign card_id = block.id | append: '-' | append: product.id %}
{% assign accent_color = '#40C4FF' %}
{% assign media_count = product.media | size %}

{% liquid
  assign has_multiple_media = false
  if media_count > 1
    assign has_multiple_media = true
  endif

  assign on_sale = false
  if product.compare_at_price > product.price
    assign on_sale = true
  endif

  assign sold_out = false
  unless product.available
    assign sold_out = true
  endunless

  assign show_badge = false
  if product.tags contains 'best-seller' or product.tags contains 'Best Seller'
    assign show_badge = true
  endif

  assign discount_percent = 0
  if on_sale and product.compare_at_price > 0
    assign price_difference = product.compare_at_price | minus: product.price
    assign discount_percent = price_difference | times: 100 | divided_by: product.compare_at_price
  endif
%}

{% style %}
  .product-card-{{ card_id }} {
    background-color: #FFFFFF;
    border: 1px solid #F0F0F0;
    border-radius: 10px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    transition: box-shadow 0.3s ease, transform 0.3s ease;
    height: 100%;
  }

  .product-card-{{ card_id }}:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    transform: translateY(-4px);
  }

  /* Top section - Badge and Heart */
  .product-card-top-{{ card_id }} {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-shrink: 0;
  }

  .product-card-badge-{{ card_id }} {
    background-color: #FFFFFF;
    color: #000000;
    font-size: 14px;
    font-weight: 700;
    padding: 6px 12px;
    border-radius: 10px;
  }



  /* Image section with swipeable slider */
  .product-card-image-wrapper-{{ card_id }} {
    position: relative;
    margin-bottom: 8px;
    flex-shrink: 0;
    border-radius: 10px;
    overflow: hidden;
  }

  .product-card-slider-{{ card_id }} {
    position: relative;
    overflow: hidden;
    border-radius: 10px;
  }

  /* Navigation arrows - visible by default for smooth swiping */
  .product-card-arrow-{{ card_id }} {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 1;
    visibility: visible;
    transition: all 0.3s ease;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .product-card-arrow-{{ card_id }}:hover {
    background-color: #FFFFFF;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    transform: translateY(-50%) scale(1.1);
  }

  .product-card-arrow-prev-{{ card_id }} {
    left: 8px;
  }

  .product-card-arrow-next-{{ card_id }} {
    right: 8px;
  }

  .product-card-arrow-{{ card_id }}:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .product-card-arrow-{{ card_id }} svg {
    width: 16px;
    height: 16px;
    color: #000000;
  }

  .product-card-slider-container-{{ card_id }} {
    display: flex;
    transition: transform 0.3s ease;
    cursor: grab;
    width: 100%;
    touch-action: pan-y;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
  }

  .product-card-slider-container-{{ card_id }}.dragging {
    cursor: grabbing;
    transition: none;
  }

  .product-card-slider-container-{{ card_id }} > * {
    flex: 0 0 100%;
  }

  .product-card-image-{{ card_id }} {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: contain;
    flex-shrink: 0;
    user-select: none;
    pointer-events: none;
    border-radius: 10px;
  }

  /* Pagination dots */
  .product-card-dots-{{ card_id }} {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 4px;
    margin-top: 8px;
  }

  .product-card-dot-{{ card_id }} {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #CCCCCC;
    transition: background-color 0.3s ease;
    cursor: pointer;
  }

  .product-card-dot-{{ card_id }}.active {
    background-color: {{ accent_color }};
  }

  /* Bottom section */
  .product-card-content-{{ card_id }} {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
    min-height: 0;
  }

  .product-card-brand-{{ card_id }} {
    font-size: 12px;
    font-weight: 400;
    color: {{ accent_color }};
    margin: 0;
    flex-shrink: 0;
  }

  .product-card-brand-link-{{ card_id }} {
    color: inherit;
    text-decoration: none;
  }

  .product-card-brand-link-{{ card_id }}:hover {
    opacity: 0.85;
  }

  .product-card-title-{{ card_id }} {
    font-size: 16px;
    font-weight: 700;
    color: #000000;
    margin: 0;
    line-height: 1.3;
    flex: 1;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .product-card-title-{{ card_id }} a {
    color: inherit;
    text-decoration: none;
    transition: opacity 0.3s ease;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .product-card-title-{{ card_id }} a:hover {
    opacity: 0.7;
  }

  .product-card-price-{{ card_id }} {
    font-size: 14px;
    font-weight: 400;
    color: #000000;
    margin: 0;
    flex-shrink: 0;
  }

  .product-card-price-{{ card_id }} .compare-price {
    text-decoration: line-through;
    opacity: 0.6;
    margin-left: 8px;
  }

  .product-card-single-image-link-{{ card_id }} {
    display: block;
    border-radius: 10px;
    overflow: hidden;
  }

  .product-card-discount-badge-{{ card_id }} {
    position: absolute;
    top: 12px;
    right: 12px;
    background-color: #FF3B30;
    color: #FFFFFF;
    font-size: 12px;
    font-weight: 700;
    padding: 6px 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 11;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
  }

  @media screen and (max-width: 749px) {
    .product-card-discount-badge-{{ card_id }} {
      top: 6px;
      right: 6px;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 8px;
    }
  }

  /* Buy Now button */
  .product-card-buy-btn-{{ card_id }} {
    width: 100%;
    background-color: {{ accent_color }};
    color: #000000;
    font-size: 16px;
    font-weight: 700;
    border: none;
    border-radius: 10px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 8px;
    flex-shrink: 0;
  }

  .product-card-buy-btn-{{ card_id }}:hover:not(:disabled) {
    opacity: 0.9;
    transform: scale(1.02);
  }

  .product-card-buy-btn-{{ card_id }}:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  @media screen and (max-width: 749px) {
    .product-card-{{ card_id }} {
    }

    .product-card-title-{{ card_id }} {
      font-size: 14px;
    }

    .product-card-buy-btn-{{ card_id }} {
      font-size: 14px;
      padding: 12px;
    }
  }
{% endstyle %}

<card-slider class="product-card-{{ card_id }}" data-total-slides="{{ product.media.size | default: 1 | at_most: 3 }}">
  <!-- Top Section: Badge -->
  {% if show_badge %}
    <div class="product-card-top-{{ card_id }}" style="margin-bottom: 4px;">
      <span class="product-card-badge-{{ card_id }}">Best Seller</span>
    </div>
  {% endif %}

  <!-- Image Section with Swipeable Slider -->
  <div class="product-card-image-wrapper-{{ card_id }}">
    {%- assign is_best_seller = false -%}
    {%- for collection in product.collections -%}
      {%- if collection.title == 'Best Sellers' -%}
        {%- assign is_best_seller = true -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
    
    {%- if is_best_seller -%}
      <img src="https://cdn.shopify.com/s/files/1/0665/2887/0715/files/1722944964203-352234792-BADGES1.png?v=1722945193" 
           alt="Best Seller"
           class="best-seller-badge-image"
           style="position: absolute; top: 10px; left: 10px; z-index: 5; width: 70px; height: auto;">
    {%- endif -%}
    {% if on_sale and discount_percent > 0 %}
      <div class="product-card-discount-badge-{{ card_id }}">
        Save {{ discount_percent | round }}%
      </div>
    {% endif %}

    {% if has_multiple_media %}
      <div class="product-card-slider-{{ card_id }}">
        <!-- Previous Arrow -->
        <button
          class="product-card-arrow-{{ card_id }} product-card-arrow-prev-{{ card_id }}"
          aria-label="Previous image"
          data-arrow-prev
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
          </svg>
        </button>

        <!-- Next Arrow -->
        <button
          class="product-card-arrow-{{ card_id }} product-card-arrow-next-{{ card_id }}"
          aria-label="Next image"
          data-arrow-next
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
          </svg>
        </button>

        <div class="product-card-slider-container-{{ card_id }}" data-slider data-product-url="{{ product.url }}">
          {% if media_count > 0 %}
            {% for media in product.media limit: 3 %}
              {% if media.media_type == 'image' %}
                <img
                  src="{{ media | image_url: width: 400 }}"
                  alt="{{ media.alt | escape }}"
                  loading="lazy"
                  width="400"
                  height="400"
                  class="product-card-image-{{ card_id }}"
                >
              {% elsif media.media_type == 'video' %}
                <video
                  class="product-card-image-{{ card_id }}"
                  muted
                  loop
                  playsinline
                  onclick="this.paused ? this.play() : this.pause()"
                >
                  <source src="{{ media.sources[1].url }}" type="video/mp4">
                </video>
              {% endif %}
            {% endfor %}
          {% else %}
            {{ 'product-' | append: product.id | placeholder_svg_tag: 'product-card-image-' | append: card_id }}
          {% endif %}
        </div>
      </div>

      <!-- Pagination Dots -->
      <div class="product-card-dots-{{ card_id }}">
        {% for media in product.media limit: 3 %}
          <span
            class="product-card-dot-{{ card_id }}{% if forloop.first %} active{% endif %}"
            data-dot
            data-index="{{ forloop.index | minus: 1 }}"
          ></span>
        {% endfor %}
      </div>
    {% else %}
      <a
        href="{{ product.url }}"
        class="product-card-single-image-link-{{ card_id }}"
        aria-label="{{ product.title | escape }}"
      >
        {% if product.featured_image %}
          <img
            src="{{ product.featured_image | image_url: width: 400 }}"
            alt="{{ product.featured_image.alt | escape }}"
            loading="lazy"
            width="400"
            height="400"
            class="product-card-image-{{ card_id }}"
          >
        {% else %}
          {{ 'product-' | append: product.id | placeholder_svg_tag: 'product-card-image-' | append: card_id }}
        {% endif %}
      </a>
    {% endif %}
  </div>

  <!-- Bottom Section: Brand, Title, Price, Button -->
  <div class="product-card-content-{{ card_id }}">
    {% if product.vendor %}
      {%- assign vendor_handle = product.vendor | handleize -%}
      <p class="product-card-brand-{{ card_id }}">
        <a href="{{ routes.collections_url }}/{{ vendor_handle }}" class="product-card-brand-link-{{ card_id }}">
          {{ product.vendor }}
        </a>
      </p>
    {% endif %}

    <h3 class="product-card-title-{{ card_id }}">
      <a href="{{ product.url }}">{{ product.title }}</a>
    </h3>

    <p class="product-card-price-{{ card_id }}">
      {% if on_sale %}
        <span class="sale-price">{{ product.price | money }}</span>
        <span class="compare-price">{{ product.compare_at_price | money }}</span>
      {% else %}
        {{ product.price | money }}
      {% endif %}
    </p>

    {% comment %} {% if sold_out %}
      <button class="product-card-buy-btn-{{ card_id }} disabled" disabled>{{ 'products.product.sold_out' | t | default: 'Sold Out' }}</button>
    {% else %}
      <button type="button" class="product-card-buy-btn-{{ card_id }}" onclick="handleAddToCart(event, {{ product.selected_or_first_available_variant.id }})">
        {{ 'Add to Cart' }}
      </button>

    {% endif %} {% endcomment %}
     <div class="product-card-buy-form-{{ card_id }}">
        {% if sold_out %}
          <button class="product-card-buy-btn-{{ card_id }} disabled" disabled>{{ 'products.product.sold_out' | t | default: 'Sold Out' }}</button>
        {% else %}
            <button type="button" class="collectionPreorderAddToCartBtn product-card-buy-btn-{{ card_id }}" onclick="handleAddToCart(event, {{ product.selected_or_first_available_variant.id }})">
              {{ 'Add to Cart' }}
            </button>
        {% endif %}
      </div>
  </div>
</card-slider>

<script>

  function handleAddToCart(event, variantId) {
    event.preventDefault();
    event.stopPropagation();
    
    const button = event.currentTarget;
    const originalText = button.textContent;
    button.textContent = 'Adding...';
    button.disabled = true;

    // Dynamically find section IDs to update (Cart Drawer, Cart Bubble)
    const sections = [];
    document.querySelectorAll('cart-items-component').forEach(el => {
        if (el.dataset.sectionId) sections.push(el.dataset.sectionId);
    });
    // Add cart-icon-bubble section if present (often requires specific ID targeting or is part of header)
    // We rely on component-cart-items to handle its own section update if included, 
    // or if we miss it, the event dispatch will trigger a re-render fallback if configured.

    const formData = {
     'items': [{
      'id': variantId,
      'quantity': 1
      }],
      'sections': sections,
      'sections_url': window.location.pathname
    };

    fetch(window.Shopify.routes.root + 'cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    })
    .then(response => {
      return response.json();
    })
    .then(data => {
      // Dispatch event to open drawer and update content
      // Structure matches CartAddEvent/CartUpdateEvent expectations in component-cart-items.js
      const eventDetail = {
          resource: data, 
          sourceId: 'product-card', 
          data: {
              source: 'product-card',
              itemCount: 1, 
              sections: data.sections
          }
      };

      document.dispatchEvent(new CustomEvent('cart:update', { 
          bubbles: true, 
          detail: eventDetail 
      }));

      // Dispatch additional event for drawer auto-open
      document.dispatchEvent(new CustomEvent('ajaxProduct:added', {
          bubbles: true,
          detail: eventDetail
      }));

      // Directly open the cart drawer for better UX
      const cartDrawer = document.querySelector('cart-drawer-component');
      if (cartDrawer && typeof cartDrawer.open === 'function') {
          cartDrawer.open();
      }
      
      button.textContent = 'Added';
      setTimeout(() => {
        button.textContent = originalText;
        button.disabled = false;
      }, 2000);
    })
    .catch((error) => {
      console.error('Error:', error);
      button.textContent = originalText;
      button.disabled = false;
    });
  }
</script>
