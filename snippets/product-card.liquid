{%- comment -%}
  Product Card Snippet - New Design
  Features: Best Seller badge, heart icon, swipeable image dots, Buy Now button (#40C4FF)
  Fixed height cards with title truncation

  @param {object} product - The product object
  @param {object} children - The children of the product card
  @param {object} [block] - The block object
{%- endcomment -%}

{% assign block_settings = block.settings %}
{% assign card_id = block.id | append: '-' | append: product.id %}
{% assign accent_color = '#40C4FF' %}
{% assign media_count = product.media | size %}

{% liquid
  assign has_multiple_media = false
  if media_count > 1
    assign has_multiple_media = true
  endif

  assign on_sale = false
  if product.compare_at_price > product.price
    assign on_sale = true
  endif

  assign sold_out = false
  unless product.available
    assign sold_out = true
  endunless

  assign show_badge = false
  if product.tags contains 'best-seller' or product.tags contains 'Best Seller'
    assign show_badge = true
  endif

  assign discount_percent = 0
  if on_sale and product.compare_at_price > 0
    assign price_difference = product.compare_at_price | minus: product.price
    assign discount_percent = price_difference | times: 100 | divided_by: product.compare_at_price
  endif
%}

{% style %}
  .product-card-{{ card_id }} {
    background-color: #FFFFFF;
    border: 1px solid #F0F0F0;
    border-radius: 10px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    transition: box-shadow 0.3s ease, transform 0.3s ease;
    height: 100%;
    min-height: 480px;
  }

  .product-card-{{ card_id }}:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    transform: translateY(-4px);
  }

  /* Top section - Badge and Heart */
  .product-card-top-{{ card_id }} {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
    flex-shrink: 0;
  }

  .product-card-badge-{{ card_id }} {
    background-color: #FFFFFF;
    color: #000000;
    font-size: 14px;
    font-weight: 700;
    padding: 6px 12px;
    border-radius: 10px;
  }

  .product-card-wishlist-{{ card_id }} {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease;
    flex-shrink: 0;
  }

  .product-card-wishlist-{{ card_id }}:hover {
    transform: scale(1.1);
  }

  .product-card-wishlist-{{ card_id }} svg {
    width: 24px;
    height: 24px;
    color: #FF0000;
    fill: none;
    transition: fill 0.2s ease;
  }

  .product-card-wishlist-{{ card_id }}.active svg {
    fill: #FF0000;
  }

  /* Image section with swipeable slider */
  .product-card-image-wrapper-{{ card_id }} {
    position: relative;
    margin-bottom: 16px;
    flex-shrink: 0;
    border-radius: 10px;
    overflow: hidden;
  }

  .product-card-slider-{{ card_id }} {
    position: relative;
    overflow: hidden;
    border-radius: 10px;
  }

  /* Navigation arrows */
  .product-card-slider-{{ card_id }}:hover .product-card-arrow-{{ card_id }} {
    opacity: 1;
    visibility: visible;
  }

  .product-card-arrow-{{ card_id }} {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .product-card-arrow-{{ card_id }}:hover {
    background-color: #FFFFFF;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    transform: translateY(-50%) scale(1.1);
  }

  .product-card-arrow-prev-{{ card_id }} {
    left: 8px;
  }

  .product-card-arrow-next-{{ card_id }} {
    right: 8px;
  }

  .product-card-arrow-{{ card_id }}:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    visibility: hidden;
  }

  .product-card-arrow-{{ card_id }} svg {
    width: 16px;
    height: 16px;
    color: #000000;
  }

  .product-card-slider-container-{{ card_id }} {
    display: flex;
    transition: transform 0.3s ease;
    cursor: grab;
    width: 100%;
    touch-action: pan-y;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
  }

  .product-card-slider-container-{{ card_id }}.dragging {
    cursor: grabbing;
    transition: none;
  }

  .product-card-slider-container-{{ card_id }} > * {
    flex: 0 0 100%;
  }

  .product-card-image-{{ card_id }} {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: contain;
    flex-shrink: 0;
    user-select: none;
    pointer-events: none;
    border-radius: 10px;
  }

  /* Pagination dots */
  .product-card-dots-{{ card_id }} {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 4px;
    margin-top: 8px;
  }

  .product-card-dot-{{ card_id }} {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #CCCCCC;
    transition: background-color 0.3s ease;
    cursor: pointer;
  }

  .product-card-dot-{{ card_id }}.active {
    background-color: {{ accent_color }};
  }

  /* Bottom section */
  .product-card-content-{{ card_id }} {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
    min-height: 0;
  }

  .product-card-brand-{{ card_id }} {
    font-size: 12px;
    font-weight: 400;
    color: {{ accent_color }};
    margin: 0;
    flex-shrink: 0;
  }

  .product-card-title-{{ card_id }} {
    font-size: 16px;
    font-weight: 700;
    color: #000000;
    margin: 0;
    line-height: 1.3;
    flex: 1;
    min-height: 42px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .product-card-title-{{ card_id }} a {
    color: inherit;
    text-decoration: none;
    transition: opacity 0.3s ease;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .product-card-title-{{ card_id }} a:hover {
    opacity: 0.7;
  }

  .product-card-price-{{ card_id }} {
    font-size: 14px;
    font-weight: 400;
    color: #000000;
    margin: 0;
    flex-shrink: 0;
  }

  .product-card-price-{{ card_id }} .compare-price {
    text-decoration: line-through;
    opacity: 0.6;
    margin-left: 8px;
  }

  .product-card-single-image-link-{{ card_id }} {
    display: block;
    border-radius: 10px;
    overflow: hidden;
  }

  .product-card-discount-badge-{{ card_id }} {
    position: absolute;
    top: 12px;
    right: 12px;
    background-color: #FF3B30;
    color: #FFFFFF;
    font-size: 12px;
    font-weight: 700;
    padding: 6px 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 2;
    border-radius: 10px;
  }

  /* Buy Now button */
  .product-card-buy-btn-{{ card_id }} {
    width: 100%;
    background-color: {{ accent_color }};
    color: #000000;
    font-size: 16px;
    font-weight: 700;
    border: none;
    border-radius: 10px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: auto;
    flex-shrink: 0;
  }

  .product-card-buy-btn-{{ card_id }}:hover:not(:disabled) {
    opacity: 0.9;
    transform: scale(1.02);
  }

  .product-card-buy-btn-{{ card_id }}:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  @media screen and (max-width: 749px) {
    .product-card-{{ card_id }} {
      min-height: 420px;
    }

    .product-card-title-{{ card_id }} {
      font-size: 14px;
      min-height: 38px;
    }

    .product-card-buy-btn-{{ card_id }} {
      font-size: 14px;
      padding: 12px;
    }
  }
{% endstyle %}

<div class="product-card-{{ card_id }}">
  <!-- Top Section: Badge and Heart -->
  <div class="product-card-top-{{ card_id }}">
    {% if show_badge %}
      <span class="product-card-badge-{{ card_id }}">Best Seller</span>
    {% endif %}
    <button
      class="product-card-wishlist-{{ card_id }}"
      aria-label="Add to wishlist"
      data-product-handle="{{ product.handle }}"
      onclick="toggleWishlist(this, '{{ product.handle }}')"
    >
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
      </svg>
    </button>
  </div>

  <!-- Image Section with Swipeable Slider -->
  <div class="product-card-image-wrapper-{{ card_id }}">
    {% if on_sale and discount_percent > 0 %}
      <div class="product-card-discount-badge-{{ card_id }}">
        Save {{ discount_percent | round }}%
      </div>
    {% endif %}

    {% if has_multiple_media %}
      <div class="product-card-slider-{{ card_id }}">
        <!-- Previous Arrow -->
        <button
          class="product-card-arrow-{{ card_id }} product-card-arrow-prev-{{ card_id }}"
          aria-label="Previous image"
          data-direction="prev"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
          </svg>
        </button>

        <!-- Next Arrow -->
        <button
          class="product-card-arrow-{{ card_id }} product-card-arrow-next-{{ card_id }}"
          aria-label="Next image"
          data-direction="next"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
          </svg>
        </button>

        <div class="product-card-slider-container-{{ card_id }}" id="slider-{{ card_id }}" data-product-url="{{ product.url }}">
          {% if media_count > 0 %}
            {% for media in product.media limit: 3 %}
              {% if media.media_type == 'image' %}
                <img
                  src="{{ media | image_url: width: 400 }}"
                  alt="{{ media.alt | escape }}"
                  loading="lazy"
                  width="400"
                  height="400"
                  class="product-card-image-{{ card_id }}"
                >
              {% elsif media.media_type == 'video' %}
                <video
                  class="product-card-image-{{ card_id }}"
                  muted
                  loop
                  playsinline
                  onclick="this.paused ? this.play() : this.pause()"
                >
                  <source src="{{ media.sources[1].url }}" type="video/mp4">
                </video>
              {% endif %}
            {% endfor %}
          {% else %}
            {{ 'product-' | append: product.id | placeholder_svg_tag: 'product-card-image-' | append: card_id }}
          {% endif %}
        </div>
      </div>

      <!-- Pagination Dots -->
      <div class="product-card-dots-{{ card_id }}" id="dots-{{ card_id }}">
        {% for media in product.media limit: 3 %}
          <span
            class="product-card-dot-{{ card_id }}{% if forloop.first %} active{% endif %}"
            data-index="{{ forloop.index | minus: 1 }}"
          ></span>
        {% endfor %}
      </div>
    {% else %}
      <a
        href="{{ product.url }}"
        class="product-card-single-image-link-{{ card_id }}"
        aria-label="{{ product.title | escape }}"
      >
        {% if product.featured_image %}
          <img
            src="{{ product.featured_image | image_url: width: 400 }}"
            alt="{{ product.featured_image.alt | escape }}"
            loading="lazy"
            width="400"
            height="400"
            class="product-card-image-{{ card_id }}"
          >
        {% else %}
          {{ 'product-' | append: product.id | placeholder_svg_tag: 'product-card-image-' | append: card_id }}
        {% endif %}
      </a>
    {% endif %}
  </div>

  <!-- Bottom Section: Brand, Title, Price, Button -->
  <div class="product-card-content-{{ card_id }}">
    {% if product.vendor %}
      <p class="product-card-brand-{{ card_id }}">{{ product.vendor }}</p>
    {% endif %}

    <h3 class="product-card-title-{{ card_id }}">
      <a href="{{ product.url }}">{{ product.title }}</a>
    </h3>

    <p class="product-card-price-{{ card_id }}">
      {% if on_sale %}
        <span class="sale-price">{{ product.price | money }}</span>
        <span class="compare-price">{{ product.compare_at_price | money }}</span>
      {% else %}
        {{ product.price | money }}
      {% endif %}
    </p>

    <form method="post" action="/cart/add" class="product-card-form-{{ card_id }}">
      <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" />
      <button
        type="submit"
        class="product-card-buy-btn-{{ card_id }}"
        {% if sold_out %}disabled{% endif %}
      >
        {% if sold_out %}
          Sold Out
        {% else %}
          Buy Now
        {% endif %}
      </button>
    </form>
  </div>
</div>

<script>
  (function() {
    const cardId = '{{ card_id }}';
    const cardElement = document.querySelector('.product-card-' + cardId);
    const slider = document.getElementById('slider-' + cardId);
    const dotsContainer = document.getElementById('dots-' + cardId);
    const dots = dotsContainer?.querySelectorAll('.product-card-dot-' + cardId);
    const prevArrow = cardElement?.querySelector('.product-card-arrow-prev-' + cardId);
    const nextArrow = cardElement?.querySelector('.product-card-arrow-next-' + cardId);

    if (!slider) return;

    let currentIndex = 0;
    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;
    let prevTranslate = 0;
    let startTime = 0;

    const totalSlides = {{ product.media.size | default: 1 | at_most: 3 }};

    // Update dots
    function updateDots(index) {
      if (dots) {
        dots.forEach((dot, i) => {
          dot.classList.toggle('active', i === index);
        });
      }
    }

    // Update arrow button states
    function updateArrows(index) {
      if (prevArrow) {
        prevArrow.disabled = index === 0;
      }
      if (nextArrow) {
        nextArrow.disabled = index === totalSlides - 1;
      }
    }

    // Slide to specific index
    function slideTo(index) {
      if (index < 0) index = totalSlides - 1;
      if (index >= totalSlides) index = 0;

      currentIndex = index;
      currentTranslate = index * -100;
      prevTranslate = currentTranslate;
      slider.style.transform = 'translateX(' + currentTranslate + '%)';
      updateDots(index);
      updateArrows(index);
    }

    slideTo(0);

    // Arrow button clicks
    if (prevArrow) {
      prevArrow.addEventListener('click', function(e) {
        e.stopPropagation();
        if (currentIndex > 0) {
          slideTo(currentIndex - 1);
        }
      });
    }

    if (nextArrow) {
      nextArrow.addEventListener('click', function(e) {
        e.stopPropagation();
        if (currentIndex < totalSlides - 1) {
          slideTo(currentIndex + 1);
        }
      });
    }

    // Prevent default drag behavior on images
    slider.querySelectorAll('img').forEach(function(img) {
      img.addEventListener('dragstart', function(e) { e.preventDefault(); });
      img.style.pointerEvents = 'none';
    });

    function getClientX(e) {
      if (e.touches && e.touches.length > 0) {
        return e.touches[0].clientX;
      }
      if (e.changedTouches && e.changedTouches.length > 0) {
        return e.changedTouches[0].clientX;
      }
      return e.clientX || 0;
    }

    // Touch start handler
    function handleTouchStart(e) {
      if (e.target.closest('.product-card-arrow-' + cardId)) return;
      
      isDragging = true;
      startX = getClientX(e);
      startTime = Date.now();
      prevTranslate = currentIndex * -100;
      slider.classList.add('dragging');
      slider.style.transition = 'none';
    }

    // Touch move handler
    function handleTouchMove(e) {
      if (!isDragging) return;
      
      var currentX = getClientX(e);
      var diff = currentX - startX;
      var movePercent = (diff / slider.offsetWidth) * 100;
      currentTranslate = prevTranslate + movePercent;
      slider.style.transform = 'translateX(' + currentTranslate + '%)';
      
      // Prevent page scrolling during horizontal swipe
      if (Math.abs(diff) > 10 && e.cancelable) {
        e.preventDefault();
      }
    }

    // Touch end handler
    function handleTouchEnd(e) {
      if (!isDragging) return;
      
      isDragging = false;
      slider.classList.remove('dragging');
      slider.style.transition = 'transform 0.3s ease';

      var endX = getClientX(e);
      var diff = endX - startX;
      var absDiff = Math.abs(diff);
      var timeDiff = Date.now() - startTime;

      // Determine if this was a swipe
      if (absDiff > 30 && timeDiff < 500) {
        if (diff < 0 && currentIndex < totalSlides - 1) {
          slideTo(currentIndex + 1);
        } else if (diff > 0 && currentIndex > 0) {
          slideTo(currentIndex - 1);
        } else {
          slideTo(currentIndex);
        }
      } else {
        slideTo(currentIndex);
        // Navigate if it was a tap
        if (absDiff < 10 && timeDiff < 300) {
          var url = slider.getAttribute('data-product-url');
          if (url) window.location.href = url;
        }
      }
    }

    // Mouse handlers
    function handleMouseDown(e) {
      if (e.target.closest('.product-card-arrow-' + cardId)) return;
      
      e.preventDefault();
      isDragging = true;
      startX = e.clientX;
      startTime = Date.now();
      prevTranslate = currentIndex * -100;
      slider.classList.add('dragging');
      slider.style.transition = 'none';
      
      // Add move and up listeners to document so we track even if mouse leaves element
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    }

    function handleMouseMove(e) {
      if (!isDragging) return;
      
      var currentX = e.clientX;
      var diff = currentX - startX;
      var movePercent = (diff / slider.offsetWidth) * 100;
      currentTranslate = prevTranslate + movePercent;
      slider.style.transform = 'translateX(' + currentTranslate + '%)';
    }

    function handleMouseUp(e) {
      if (!isDragging) return;
      
      isDragging = false;
      slider.classList.remove('dragging');
      slider.style.transition = 'transform 0.3s ease';
      
      // Remove document listeners
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);

      var endX = e.clientX;
      var diff = endX - startX;
      var absDiff = Math.abs(diff);
      var timeDiff = Date.now() - startTime;

      if (absDiff > 30 && timeDiff < 500) {
        if (diff < 0 && currentIndex < totalSlides - 1) {
          slideTo(currentIndex + 1);
        } else if (diff > 0 && currentIndex > 0) {
          slideTo(currentIndex - 1);
        } else {
          slideTo(currentIndex);
        }
      } else {
        slideTo(currentIndex);
        if (absDiff < 10 && timeDiff < 300) {
          var url = slider.getAttribute('data-product-url');
          if (url) window.location.href = url;
        }
      }
    }

    // Attach touch events to slider
    slider.addEventListener('touchstart', handleTouchStart, { passive: true });
    slider.addEventListener('touchmove', handleTouchMove, { passive: false });
    slider.addEventListener('touchend', handleTouchEnd, { passive: true });
    slider.addEventListener('touchcancel', function() {
      if (isDragging) {
        isDragging = false;
        slider.classList.remove('dragging');
        slideTo(currentIndex);
      }
    });

    // Attach mouse event only for mousedown on slider
    slider.addEventListener('mousedown', handleMouseDown);

    // Dot clicks
    if (dots) {
      dots.forEach(function(dot, index) {
        dot.addEventListener('click', function(e) {
          e.stopPropagation();
          slideTo(index);
        });
      });
    }

    // Initialize arrow states
    updateArrows(0);
  })();

  // Wishlist toggle (global function)
  function toggleWishlist(button, productHandle) {
    button.classList.toggle('active');
    const isActive = button.classList.contains('active');
    if (isActive) {
      console.log('Added to wishlist:', productHandle);
    } else {
      console.log('Removed from wishlist:', productHandle);
    }
  }
</script>
